# LangChain ä»‹ç´¹

## ä»€éº¼æ˜¯ LangChainï¼Ÿ

LangChain æ˜¯ä¸€å€‹å¤šåŠŸèƒ½çš„æ¡†æ¶ï¼Œå¯ä»¥ç”¨ä¾†å»ºç«‹åˆ©ç”¨å¤§å‹èªè¨€æ¨¡å‹ï¼ˆLLMsï¼‰çš„æ‡‰ç”¨ç¨‹å¼ï¼Œç›®å‰æä¾› Python èˆ‡ TypeScript ç‰ˆæœ¬ã€‚

å®ƒçš„æ ¸å¿ƒç†å¿µæ˜¯ï¼šæœ€æœ‰å½±éŸ¿åŠ›ã€æœ€å…·ç‰¹è‰²çš„æ‡‰ç”¨ï¼Œä¸æ‡‰åƒ…åƒ…é€é API èˆ‡èªè¨€æ¨¡å‹äº’å‹•ï¼Œè€Œæ‡‰è©²åŒæ™‚åšåˆ°ä»¥ä¸‹å…©é»ï¼š

### ğŸ” å¢å¼·è³‡æ–™æ„ŸçŸ¥ï¼ˆEnhance Data Awarenessï¼‰

**æ ¸å¿ƒæ¦‚å¿µï¼š** è®“ LLM ä¸å†æ˜¯ã€Œé–‰é–€é€ è»Šã€ï¼Œè€Œæ˜¯èƒ½ä¸»å‹•æ„ŸçŸ¥ã€æª¢ç´¢ä¸¦æ•´åˆå¤–éƒ¨è³‡æ–™ã€‚

#### ç‚ºä»€éº¼éœ€è¦è³‡æ–™æ„ŸçŸ¥ï¼Ÿ

æƒ³åƒä¸€ä¸‹é€™äº›æƒ…å¢ƒï¼š

ğŸ“‹ **å‚³çµ± LLM çš„é™åˆ¶**ï¼š
- å•ï¼šã€Œæˆ‘å€‘å…¬å¸çš„è«‹å‡æ”¿ç­–æ˜¯ä»€éº¼ï¼Ÿã€
- ç­”ï¼šã€Œæˆ‘ç„¡æ³•çŸ¥é“æ‚¨å…¬å¸çš„å…·é«”æ”¿ç­–...ã€

ğŸ¯ **å¢å¼·è³‡æ–™æ„ŸçŸ¥å¾Œ**ï¼š
- å•ï¼šã€Œæˆ‘å€‘å…¬å¸çš„è«‹å‡æ”¿ç­–æ˜¯ä»€éº¼ï¼Ÿã€  
- ç­”ï¼šã€Œæ ¹æ“šå…¬å¸æ‰‹å†Šï¼Œå“¡å·¥æ¯å¹´äº«æœ‰14å¤©å¹´å‡ï¼Œç—…å‡éœ€è¦æå‰é€šçŸ¥...ã€

#### å¯¦éš›æ‡‰ç”¨å ´æ™¯

**å ´æ™¯ä¸€ï¼šä¼æ¥­å®¢æœæ©Ÿå™¨äºº**
- **å•é¡Œ**ï¼šå®¢æˆ¶å•è¨‚å–®ç‹€æ…‹ï¼Œå‚³çµ± AI ç„¡æ³•æŸ¥è©¢
- **è§£æ±º**ï¼šæ¥å…¥è¨‚å–®ç³»çµ±ï¼Œå³æ™‚æŸ¥è©¢å›ç­”

**å ´æ™¯äºŒï¼šæ³•å‹™æ–‡ä»¶åˆ†æ**  
- **å•é¡Œ**ï¼šéœ€è¦å¾å¤§é‡åˆç´„ä¸­æ‰¾ç‰¹å®šæ¢æ¬¾
- **è§£æ±º**ï¼šæƒææ‰€æœ‰æ–‡ä»¶ï¼Œç²¾æº–å®šä½ç›¸é—œå…§å®¹

**å ´æ™¯ä¸‰ï¼šå€‹äººå¥åº·åŠ©æ‰‹**
- **å•é¡Œ**ï¼šAI ä¸çŸ¥é“ä½ çš„å¥åº·ç´€éŒ„
- **è§£æ±º**ï¼šæ•´åˆå¥åº·æ•¸æ“šï¼Œæä¾›å€‹äººåŒ–å»ºè­°

#### æŠ€è¡“å¯¦ç¾å±¤ç´š

| å±¤ç´š | èƒ½åŠ› | å¯¦éš›ä¾‹å­ |
|------|------|---------|
| **éœæ…‹æ„ŸçŸ¥** | é å…ˆè¼‰å…¥çš„çŸ¥è­˜åº« | å…¬å¸FAQã€ç”¢å“æ‰‹å†Šå•ç­” |
| **å‹•æ…‹æ„ŸçŸ¥** | å¯¦æ™‚è³‡æ–™æª¢ç´¢ | è‚¡åƒ¹æŸ¥è©¢ã€å¤©æ°£é å ± |
| **ä¸Šä¸‹æ–‡æ„ŸçŸ¥** | å°è©±æ­·å²è¨˜æ†¶ | è¨˜ä½ä½ çš„åå¥½å’Œéœ€æ±‚ |
| **ç’°å¢ƒæ„ŸçŸ¥** | æ„ŸçŸ¥å¤–éƒ¨ç³»çµ±ç‹€æ…‹ | ç›£æ§ç³»çµ±å‘Šè­¦ã€IoTè¨­å‚™æ•¸æ“š |

#### ç¨‹å¼ç¢¼å¯¦ç¾ç¯„ä¾‹

::: details é»æ“ŠæŸ¥çœ‹ï¼šæª¢ç´¢å¢å¼·ç”Ÿæˆ (RAG) å¯¦ä½œ
```python
# åŒ¯å…¥ LangChain RAG ç›¸é—œæ¨¡çµ„
from langchain.chains.retrieval import create_retrieval_chain
from langchain.chains.combine_documents import create_stuff_documents_chain
from langchain_chroma import Chroma
from langchain_community.document_loaders import PyPDFLoader
from langchain_text_splitters import RecursiveCharacterTextSplitter
from langchain_core.prompts import ChatPromptTemplate

# å®‰è£å¿…è¦å¥—ä»¶ï¼š
# pip install -U langchain langchain-openai langchain-community langchain-chroma pypdf

# æ­¥é©Ÿ 1: è¼‰å…¥å¤–éƒ¨æ–‡ä»¶
# PyPDFLoader å¯ä»¥è®€å– PDF æª”æ¡ˆä¸¦è½‰æ›ç‚º LangChain æ–‡ä»¶æ ¼å¼
loader = PyPDFLoader("company_handbook.pdf")
documents = loader.load()  # è¼‰å…¥æ‰€æœ‰é é¢ä½œç‚ºç¨ç«‹æ–‡ä»¶
print(f"è¼‰å…¥äº† {len(documents)} é æ–‡ä»¶")

# æ­¥é©Ÿ 2: æ–‡ä»¶åˆ‡åˆ†è™•ç†
# ç”±æ–¼æ–‡ä»¶å¯èƒ½å¾ˆé•·ï¼Œéœ€è¦åˆ‡åˆ†ç‚ºè¼ƒå°çš„ç‰‡æ®µä»¥ä¾¿æª¢ç´¢
splitter = RecursiveCharacterTextSplitter(
    chunk_size=1000,      # æ¯å€‹ç‰‡æ®µæœ€å¤§ 1000 å­—ç¬¦
    chunk_overlap=150     # ç‰‡æ®µé–“é‡ç–Š 150 å­—ç¬¦ï¼Œä¿æŒä¸Šä¸‹æ–‡é€£è²«æ€§
)
splits = splitter.split_documents(documents)
print(f"æ–‡ä»¶å·²åˆ‡åˆ†ç‚º {len(splits)} å€‹ç‰‡æ®µ")

# æ­¥é©Ÿ 3: å»ºç«‹å‘é‡è³‡æ–™åº«
# å°‡æ–‡ä»¶ç‰‡æ®µè½‰æ›ç‚ºå‘é‡ä¸¦å­˜å„²ï¼Œç”¨æ–¼å¾ŒçºŒç›¸ä¼¼åº¦æª¢ç´¢
from langchain_openai import OpenAIEmbeddings, ChatOpenAI

# ä½¿ç”¨ OpenAI çš„ embedding æ¨¡å‹å°‡æ–‡å­—è½‰æ›ç‚ºå‘é‡
embeddings = OpenAIEmbeddings()

# ä½¿ç”¨ Chroma ä½œç‚ºå‘é‡è³‡æ–™åº«ï¼Œå­˜å„²æ–‡ä»¶ç‰‡æ®µçš„å‘é‡è¡¨ç¤º
vectorstore = Chroma.from_documents(
    documents=splits,    # è¦å„²å­˜çš„æ–‡ä»¶ç‰‡æ®µ
    embedding=embeddings # å‘é‡åŒ–æ¨¡å‹
)

# å»ºç«‹æª¢ç´¢å™¨ï¼Œè¨­å®šæ¯æ¬¡æª¢ç´¢è¿”å›æœ€ç›¸é—œçš„ 4 å€‹ç‰‡æ®µ
retriever = vectorstore.as_retriever(
    search_kwargs={"k": 4}  # è¿”å›æœ€ç›¸é—œçš„å‰ 4 å€‹æ–‡ä»¶ç‰‡æ®µ
)

# æ­¥é©Ÿ 4: å»ºç«‹èªè¨€æ¨¡å‹å’Œæç¤ºæ¨¡æ¿
# ä½¿ç”¨ OpenAI çš„ GPT æ¨¡å‹é€²è¡Œæ–‡ä»¶å•ç­”
llm = ChatOpenAI(
    model="gpt-4o-mini",  # ä½¿ç”¨è¼ƒå°çš„æ¨¡å‹ä»¥ç¯€çœæˆæœ¬
    temperature=0         # è¨­å®šç‚º 0 ä»¥ç²å¾—ä¸€è‡´çš„å›ç­”
)

# å»ºç«‹æç¤ºæ¨¡æ¿ï¼Œå‘Šè¨´ AI å¦‚ä½•ä½¿ç”¨æª¢ç´¢åˆ°çš„æ–‡ä»¶å›ç­”å•é¡Œ
prompt = ChatPromptTemplate.from_template(
    """è«‹æ ¹æ“šä»¥ä¸‹æ–‡ä»¶å…§å®¹å›è¦†ç”¨æˆ¶å•é¡Œã€‚å¦‚æœæ–‡ä»¶ä¸­æ²’æœ‰ç›¸é—œè³‡è¨Šï¼Œè«‹èªªæ˜ç„¡æ³•æ‰¾åˆ°ç›¸é—œå…§å®¹ã€‚
    
    æ–‡ä»¶å…§å®¹ï¼š{context}
    
    ç”¨æˆ¶å•é¡Œï¼š{input}
    
    å›ç­”ï¼š"""
)

# æ­¥é©Ÿ 5: å»ºç«‹æ–‡ä»¶æ•´åˆéˆ
# é€™å€‹éˆè² è²¬å°‡æª¢ç´¢åˆ°çš„å¤šå€‹æ–‡ä»¶ç‰‡æ®µæ•´åˆï¼Œä¸¦ç”Ÿæˆçµ±ä¸€å›ç­”
stuff_chain = create_stuff_documents_chain(
    llm=llm,       # ä½¿ç”¨çš„èªè¨€æ¨¡å‹
    prompt=prompt  # æç¤ºæ¨¡æ¿
)

# æ­¥é©Ÿ 6: å»ºç«‹å®Œæ•´çš„ RAG éˆ (æ–°ç‰ˆ v0.2+ åšæ³•)
# çµåˆæª¢ç´¢å™¨å’Œæ–‡ä»¶æ•´åˆéˆï¼Œå½¢æˆå®Œæ•´çš„å•ç­”ç³»çµ±
rag_chain = create_retrieval_chain(
    retriever=retriever,     # æ–‡ä»¶æª¢ç´¢å™¨
    combine_docs_chain=stuff_chain  # æ–‡ä»¶æ•´åˆèˆ‡å›ç­”ç”Ÿæˆéˆ
)

# æ­¥é©Ÿ 7: ä½¿ç”¨ RAG ç³»çµ±å›ç­”å•é¡Œ
# ç¾åœ¨ LLM å¯ä»¥åŸºæ–¼å…¬å¸æ‰‹å†Šå…§å®¹å›ç­”å…·é«”å•é¡Œ
response = rag_chain.invoke({
    "input": "å…¬å¸çš„è«‹å‡æ”¿ç­–æ˜¯ä»€éº¼ï¼Ÿ"
})

# é¡¯ç¤º AI åŸºæ–¼æ–‡ä»¶å…§å®¹çš„å›ç­”
print("AI å›ç­”:", response["answer"])

# å¯é¸ï¼šæŸ¥çœ‹æª¢ç´¢åˆ°çš„ç›¸é—œæ–‡ä»¶ç‰‡æ®µ
print("\næª¢ç´¢åˆ°çš„ç›¸é—œæ–‡ä»¶ç‰‡æ®µ:")
for i, doc in enumerate(response["context"]):
    print(f"ç‰‡æ®µ {i+1}: {doc.page_content[:200]}...")
```
:::

::: details é»æ“ŠæŸ¥çœ‹ï¼šå‹•æ…‹è³‡æ–™æ³¨å…¥å¯¦ä½œ
```python
# åŒ¯å…¥å¿…è¦æ¨¡çµ„
from langchain.prompts import PromptTemplate
from datetime import datetime
import requests
import json

# æ­¥é©Ÿ 1: ç²å–å¯¦æ™‚è³‡æ–™
# æ„ŸçŸ¥ç•¶å‰ç³»çµ±æ™‚é–“ï¼Œè®“ AI çŸ¥é“ç¾åœ¨çš„æ™‚é–“è„ˆçµ¡
current_time = datetime.now().strftime("%Y-%m-%d %H:%M")
print(f"ç•¶å‰æ™‚é–“: {current_time}")

# æ­¥é©Ÿ 2: å®šç¾©è³‡æ–™ç²å–å‡½æ•¸
def get_latest_market_data():
    """
    ç²å–æœ€æ–°å¸‚å ´æ•¸æ“šçš„å‡½æ•¸
    åœ¨å¯¦éš›æ‡‰ç”¨ä¸­ï¼Œé€™è£¡æœƒèª¿ç”¨çœŸå¯¦çš„ API
    ä¾‹å¦‚ï¼šAlpha Vantageã€Yahoo Finance ç­‰
    """
    # æ¨¡æ“¬å¾å¤–éƒ¨ API ç²å–çš„å¯¦æ™‚æ•¸æ“š
    market_data = {
        "stock_price": 150.25,    # ç•¶å‰è‚¡åƒ¹
        "volume": 1000000,        # äº¤æ˜“é‡
        "trend": "up",            # è¶¨å‹¢æ–¹å‘
        "change_percent": 2.5,    # æ¼²å¹…ç™¾åˆ†æ¯”
        "last_updated": current_time  # æ•¸æ“šæ›´æ–°æ™‚é–“
    }
    return market_data

def get_weather_data(city="å°åŒ—"):
    """
    ç²å–å¤©æ°£è³‡æ–™çš„ç¯„ä¾‹å‡½æ•¸
    å¯¦éš›æ‡‰ç”¨å¯æ•´åˆ OpenWeatherMap ç­‰ API
    """
    # æ¨¡æ“¬å¤©æ°£ API å›æ‡‰
    weather_data = {
        "city": city,
        "temperature": 28,
        "condition": "æ™´å¤©",
        "humidity": 65,
        "wind_speed": 15
    }
    return weather_data

# æ­¥é©Ÿ 3: å»ºç«‹å‹•æ…‹æç¤ºæ¨¡æ¿
# é€™å€‹æ¨¡æ¿æœƒå°‡å¯¦æ™‚è³‡æ–™æ³¨å…¥åˆ°æç¤ºä¸­
prompt_template = PromptTemplate.from_template(
    """ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„é‡‘èåˆ†æå¸«ã€‚è«‹æ ¹æ“šä»¥ä¸‹è³‡è¨Šé€²è¡Œåˆ†æï¼š
    
    ç•¶å‰æ™‚é–“ï¼š{current_time}
    å¸‚å ´æ•¸æ“šï¼š{market_data}
    å¤©æ°£ç‹€æ³ï¼š{weather_info}
    
    è«‹åˆ†æç•¶å‰å¸‚å ´è¶¨å‹¢ï¼Œä¸¦è€ƒæ…®ä»¥ä¸‹å› ç´ ï¼š
    1. åƒ¹æ ¼è®Šå‹•è¶¨å‹¢
    2. äº¤æ˜“é‡è¡¨ç¾ 
    3. å¤–éƒ¨ç’°å¢ƒå½±éŸ¿ï¼ˆå¦‚å¤©æ°£å°ç›¸é—œç”¢æ¥­çš„å½±éŸ¿ï¼‰
    
    åˆ†æçµæœï¼š"""
)

# æ­¥é©Ÿ 4: ç²å–å¯¦æ™‚è³‡æ–™
market_info = get_latest_market_data()
weather_info = get_weather_data()

print("ç²å–çš„å¸‚å ´è³‡æ–™:", json.dumps(market_info, ensure_ascii=False, indent=2))
print("ç²å–çš„å¤©æ°£è³‡æ–™:", json.dumps(weather_info, ensure_ascii=False, indent=2))

# æ­¥é©Ÿ 5: å°‡å¯¦æ™‚è³‡æ–™æ³¨å…¥æç¤ºæ¨¡æ¿
# LLM ç¾åœ¨èƒ½æ„ŸçŸ¥å³æ™‚çš„å¤–éƒ¨è³‡æ–™ç‹€æ³
formatted_prompt = prompt_template.format(
    current_time=current_time,
    market_data=json.dumps(market_info, ensure_ascii=False),
    weather_info=json.dumps(weather_info, ensure_ascii=False)
)

print("\n=== å‹•æ…‹ç”Ÿæˆçš„æç¤º ===")
print(formatted_prompt)

# æ­¥é©Ÿ 6: å¯¦éš›æ‡‰ç”¨ä¸­çš„å®Œæ•´æµç¨‹
def create_dynamic_analysis(user_question):
    """
    å»ºç«‹å‹•æ…‹åˆ†æå‡½æ•¸ï¼Œæ•´åˆå¯¦æ™‚è³‡æ–™
    """
    # ç²å–æœ€æ–°è³‡æ–™
    current_data = {
        'time': datetime.now().strftime("%Y-%m-%d %H:%M"),
        'market': get_latest_market_data(),
        'weather': get_weather_data()
    }
    
    # å»ºç«‹æƒ…å¢ƒæ„ŸçŸ¥çš„æç¤º
    context_prompt = PromptTemplate.from_template(
        """åŸºæ–¼ä»¥ä¸‹å³æ™‚è³‡è¨Šï¼š
        æ™‚é–“ï¼š{time}
        å¸‚å ´ç‹€æ³ï¼š{market}
        ç’°å¢ƒè³‡è¨Šï¼š{weather}
        
        ç”¨æˆ¶å•é¡Œï¼š{question}
        
        è«‹æä¾›åŸºæ–¼ç•¶å‰æƒ…æ³çš„å°ˆæ¥­åˆ†æã€‚"""
    )
    
    return context_prompt.format(
        time=current_data['time'],
        market=current_data['market'],
        weather=current_data['weather'],
        question=user_question
    )

# ä½¿ç”¨ç¯„ä¾‹
analysis_prompt = create_dynamic_analysis("ç¾åœ¨æ˜¯å¦é©åˆæŠ•è³‡ç§‘æŠ€è‚¡ï¼Ÿ")
print("\n=== æƒ…å¢ƒæ„ŸçŸ¥åˆ†æ ===")
print(analysis_prompt)
```
:::

::: details é»æ“ŠæŸ¥çœ‹ï¼šå¤šæºè³‡æ–™æ•´åˆå¯¦ä½œ
```python
# åŒ¯å…¥å¤šæºè³‡æ–™æ•´åˆæ‰€éœ€çš„æ¨¡çµ„
from langchain_community.agent_toolkits import create_sql_agent
from langchain_community.utilities import SQLDatabase
from langchain_openai import ChatOpenAI
import sqlite3
import pandas as pd
import logging
from typing import Dict, Any

# æ­¥é©Ÿ 1: è¨­å®šæ—¥èªŒè¨˜éŒ„ï¼ˆå®‰å…¨æ©Ÿåˆ¶ï¼‰
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('sql_agent.log'),  # è¨˜éŒ„æ‰€æœ‰æ“ä½œåˆ°æª”æ¡ˆ
        logging.StreamHandler()                # åŒæ™‚åœ¨æ§åˆ¶å°é¡¯ç¤º
    ]
)
logger = logging.getLogger(__name__)

# æ­¥é©Ÿ 2: å»ºç«‹å®‰å…¨çš„è³‡æ–™åº«é€£æ¥
def create_sample_database():
    """
    å»ºç«‹ç¤ºç¯„ç”¨çš„éŠ·å”®è³‡æ–™åº«
    å¯¦éš›æ‡‰ç”¨ä¸­ï¼Œé€™æœƒæ˜¯æ‚¨ç¾æœ‰çš„æ¥­å‹™è³‡æ–™åº«
    """
    # å‰µå»º SQLite è³‡æ–™åº«å’Œç¤ºç¯„æ•¸æ“š
    conn = sqlite3.connect('sales.db')
    
    # å»ºç«‹éŠ·å”®æ•¸æ“šè¡¨
    conn.execute('''
    CREATE TABLE IF NOT EXISTS sales (
        id INTEGER PRIMARY KEY,
        date DATE NOT NULL,
        product TEXT NOT NULL,
        amount DECIMAL(10,2) NOT NULL,
        region TEXT NOT NULL,
        salesperson TEXT NOT NULL
    )
    ''')
    
    # æ’å…¥ç¤ºç¯„æ•¸æ“š
    sample_data = [
        ('2024-01-15', 'ç­†è¨˜å‹é›»è…¦', 45000, 'å°åŒ—', 'å¼µå°æ˜'),
        ('2024-01-20', 'æ™ºæ…§æ‰‹æ©Ÿ', 25000, 'é«˜é›„', 'æç¾è¯'),
        ('2023-01-18', 'ç­†è¨˜å‹é›»è…¦', 42000, 'å°åŒ—', 'ç‹å¤§åŒ'),
        ('2023-01-25', 'å¹³æ¿é›»è…¦', 18000, 'å°ä¸­', 'é™³æ·‘èŠ¬'),
    ]
    
    conn.executemany(
        'INSERT OR REPLACE INTO sales (date, product, amount, region, salesperson) VALUES (?, ?, ?, ?, ?)',
        sample_data
    )
    conn.commit()
    conn.close()
    logger.info("ç¤ºç¯„è³‡æ–™åº«å»ºç«‹å®Œæˆ")

# æ­¥é©Ÿ 3: å»ºç«‹å®‰å…¨çš„è³‡æ–™åº«é€£æ¥åŒ…è£å™¨
class SafeSQLDatabase:
    """
    å®‰å…¨çš„ SQL è³‡æ–™åº«åŒ…è£å™¨
    å¯¦æ–½å¤šå±¤å®‰å…¨æ©Ÿåˆ¶
    """
    def __init__(self, database_uri: str, allowed_tables: list = None):
        self.db = SQLDatabase.from_uri(database_uri)
        self.allowed_tables = allowed_tables or []  # ç™½åå–®æ©Ÿåˆ¶
        logger.info(f"è³‡æ–™åº«é€£æ¥å·²å»ºç«‹: {database_uri}")
    
    def validate_query(self, query: str) -> bool:
        """
        é©—è­‰ SQL æŸ¥è©¢çš„å®‰å…¨æ€§
        """
        # ç¦æ­¢çš„æ“ä½œï¼ˆé˜²æ­¢è³‡æ–™è¢«ä¿®æ”¹æˆ–åˆªé™¤ï¼‰
        forbidden_operations = ['DROP', 'DELETE', 'UPDATE', 'INSERT', 'ALTER']
        query_upper = query.upper()
        
        for operation in forbidden_operations:
            if operation in query_upper:
                logger.warning(f"ç¦æ­¢çš„æ“ä½œè¢«æ””æˆª: {operation}")
                return False
        return True

# æ­¥é©Ÿ 4: åˆå§‹åŒ–è³‡æ–™åº«å’Œ AI æ¨¡å‹
# å»ºç«‹ç¤ºç¯„è³‡æ–™åº«
create_sample_database()

# å»ºç«‹å®‰å…¨çš„è³‡æ–™åº«é€£æ¥
db = SQLDatabase.from_uri("sqlite:///sales.db")
logger.info(f"å¯ç”¨è³‡æ–™è¡¨: {db.get_usable_table_names()}")

# åˆå§‹åŒ–èªè¨€æ¨¡å‹ï¼ˆä½¿ç”¨è¼ƒå°æ¨¡å‹ä»¥ç¯€çœæˆæœ¬ï¼‰
llm = ChatOpenAI(
    model="gpt-4o-mini",  # ä½¿ç”¨æˆæœ¬æ•ˆç›Šè¼ƒé«˜çš„æ¨¡å‹
    temperature=0,        # ç¢ºä¿çµæœçš„ä¸€è‡´æ€§
    timeout=30           # è¨­å®šè¶…æ™‚ä»¥é˜²æ­¢é•·æ™‚é–“ç­‰å¾…
)
logger.info("èªè¨€æ¨¡å‹åˆå§‹åŒ–å®Œæˆ")

# æ­¥é©Ÿ 5: å»ºç«‹ SQL æ™ºèƒ½ä»£ç†
# é€™å€‹ä»£ç†èƒ½å¤ ç†è§£è‡ªç„¶èªè¨€å•é¡Œä¸¦ç”Ÿæˆç›¸æ‡‰çš„ SQL æŸ¥è©¢
sql_agent = create_sql_agent(
    llm=llm,                    # ä½¿ç”¨çš„èªè¨€æ¨¡å‹
    db=db,                      # é€£æ¥çš„è³‡æ–™åº«
    verbose=True,               # é¡¯ç¤ºæ¨ç†éç¨‹
    agent_type="openai-tools",  # ä½¿ç”¨ OpenAI å·¥å…·èª¿ç”¨åŠŸèƒ½
    handle_parsing_errors=True  # è™•ç†è§£æéŒ¯èª¤
)
logger.info("SQL ä»£ç†å»ºç«‹å®Œæˆ")

# æ­¥é©Ÿ 6: å®‰å…¨çš„æŸ¥è©¢åŸ·è¡Œå‡½æ•¸
def safe_query_execution(question: str, max_retries: int = 3) -> Dict[str, Any]:
    """
    å®‰å…¨åœ°åŸ·è¡Œ SQL æŸ¥è©¢
    åŒ…å«é‡è©¦æ©Ÿåˆ¶å’ŒéŒ¯èª¤è™•ç†
    """
    for attempt in range(max_retries):
        try:
            logger.info(f"åŸ·è¡ŒæŸ¥è©¢ (å˜—è©¦ {attempt + 1}): {question}")
            
            # è¨˜éŒ„é–‹å§‹æ™‚é–“ï¼ˆæ€§èƒ½ç›£æ§ï¼‰
            import time
            start_time = time.time()
            
            # åŸ·è¡ŒæŸ¥è©¢ï¼ˆæ–°ç‰ˆ invoke æ ¼å¼ï¼‰
            response = sql_agent.invoke({
                "input": question
            })
            
            # è¨ˆç®—åŸ·è¡Œæ™‚é–“
            execution_time = time.time() - start_time
            logger.info(f"æŸ¥è©¢åŸ·è¡ŒæˆåŠŸï¼Œè€—æ™‚: {execution_time:.2f} ç§’")
            
            return {
                "success": True,
                "output": response["output"],
                "execution_time": execution_time,
                "attempt": attempt + 1
            }
            
        except Exception as e:
            logger.error(f"æŸ¥è©¢åŸ·è¡Œå¤±æ•— (å˜—è©¦ {attempt + 1}): {str(e)}")
            if attempt == max_retries - 1:  # æœ€å¾Œä¸€æ¬¡å˜—è©¦
                return {
                    "success": False,
                    "error": str(e),
                    "attempts": max_retries
                }
            # ç­‰å¾…å¾Œé‡è©¦
            import time
            time.sleep(1)
    
    return {"success": False, "error": "è¶…éæœ€å¤§é‡è©¦æ¬¡æ•¸"}

# æ­¥é©Ÿ 7: å¯¦éš›ä½¿ç”¨ç¯„ä¾‹
print("=== å¤šæºè³‡æ–™æ•´åˆèˆ‡åˆ†æ ===")

# ç¯„ä¾‹ 1: éŠ·å”®è¶¨å‹¢åˆ†æ
result1 = safe_query_execution(
    "åˆ†ææœ¬æœˆéŠ·å”®è¶¨å‹¢ä¸¦èˆ‡å»å¹´åŒæœŸæ¯”è¼ƒï¼ŒåŒ…å«ç¸½é‡‘é¡å’Œäº¤æ˜“ç­†æ•¸"
)

if result1["success"]:
    print("\nğŸ“Š éŠ·å”®è¶¨å‹¢åˆ†æçµæœ:")
    print(result1["output"])
    print(f"â±ï¸ åŸ·è¡Œæ™‚é–“: {result1['execution_time']:.2f} ç§’")
else:
    print(f"âŒ æŸ¥è©¢å¤±æ•—: {result1['error']}")

# ç¯„ä¾‹ 2: ç”¢å“ç¸¾æ•ˆåˆ†æ
result2 = safe_query_execution(
    "å“ªå€‹ç”¢å“çš„éŠ·å”®ç¸¾æ•ˆæœ€å¥½ï¼Ÿè«‹æä¾›å…·é«”çš„æ•¸æ“šåˆ†æ"
)

if result2["success"]:
    print("\nğŸ† ç”¢å“ç¸¾æ•ˆåˆ†æçµæœ:")
    print(result2["output"])
else:
    print(f"âŒ æŸ¥è©¢å¤±æ•—: {result2['error']}")

# ç¯„ä¾‹ 3: å€åŸŸéŠ·å”®åˆ†æ
result3 = safe_query_execution(
    "æ¯”è¼ƒä¸åŒåœ°å€çš„éŠ·å”®è¡¨ç¾ï¼Œæ‰¾å‡ºè¡¨ç¾æœ€ä½³çš„å€åŸŸ"
)

if result3["success"]:
    print("\nğŸ—ºï¸ å€åŸŸéŠ·å”®åˆ†æçµæœ:")
    print(result3["output"])
else:
    print(f"âŒ æŸ¥è©¢å¤±æ•—: {result3['error']}")

# ğŸ”’ å¯¦æ–½çš„å®‰å…¨æ©Ÿåˆ¶èªªæ˜ï¼š
print("\nğŸ”’ å·²å¯¦æ–½çš„å®‰å…¨æ©Ÿåˆ¶:")
print("1. âœ… è¼¸å…¥é©—è­‰ï¼šæŸ¥è©¢å‰æª¢æŸ¥ SQL èªæ³•å®‰å…¨æ€§")
print("2. âœ… æ¬Šé™æ§åˆ¶ï¼šåƒ…å…è¨± SELECT æ“ä½œï¼Œç¦æ­¢ä¿®æ”¹è³‡æ–™")
print("3. âœ… è¶…æ™‚è¨­å®šï¼š30 ç§’æŸ¥è©¢è¶…æ™‚ï¼Œé˜²æ­¢è³‡æºæ¶ˆè€—")
print("4. âœ… é‡è©¦æ©Ÿåˆ¶ï¼šè‡ªå‹•é‡è©¦å¤±æ•—çš„æŸ¥è©¢ï¼Œæé«˜ç©©å®šæ€§")
print("5. âœ… æ—¥èªŒè¨˜éŒ„ï¼šå®Œæ•´è¨˜éŒ„æ‰€æœ‰æ“ä½œä¾›å®‰å…¨ç¨½æ ¸")
print("6. âœ… éŒ¯èª¤è™•ç†ï¼šå¦¥å–„è™•ç†å„ç¨®ç•°å¸¸æƒ…æ³")
print("7. âœ… æ€§èƒ½ç›£æ§ï¼šè¿½è¹¤æŸ¥è©¢åŸ·è¡Œæ™‚é–“")

# æ¸…ç†è³‡æº
logger.info("ç¨‹å¼åŸ·è¡Œå®Œæˆï¼Œè³‡æºæ¸…ç†ä¸­...")
```
:::


### ğŸ¤– å¢å¼·è¡Œå‹•åŠ›ï¼ˆEnhance Agencyï¼‰

**æ ¸å¿ƒæ¦‚å¿µï¼š** è®“ LLM å¾è¢«å‹•å›ç­”è®Šæˆä¸»å‹•æ±ºç­–ï¼Œèƒ½è‡ªä¸»é¸æ“‡å·¥å…·ã€è¦åŠƒæ­¥é©Ÿï¼Œä¸¦åŸ·è¡Œè¤‡é›œä»»å‹™ã€‚

#### ç‚ºä»€éº¼éœ€è¦è¡Œå‹•åŠ›ï¼Ÿ

æƒ³åƒä¸€ä¸‹ä½ æœ‰ä¸€å€‹çœŸæ­£çš„ AI åŠ©æ‰‹ï¼š

ğŸ¤– **å‚³çµ± LLM çš„é™åˆ¶**ï¼š
- ä½ ï¼šã€Œå¹«æˆ‘å®‰æ’æ˜å¤©çš„æœƒè­°ã€
- AIï¼šã€Œæˆ‘ç„¡æ³•ç›´æ¥æ“ä½œæ‚¨çš„è¡Œäº‹æ›†ï¼Œå»ºè­°æ‚¨...ã€

âš¡ **å¢å¼·è¡Œå‹•åŠ›å¾Œ**ï¼š
- ä½ ï¼šã€Œå¹«æˆ‘å®‰æ’æ˜å¤©çš„æœƒè­°ã€  
- AIï¼šã€Œæˆ‘å·²ç¶“æª¢æŸ¥äº†æ‚¨çš„è¡Œäº‹æ›†ï¼Œç™¼ç¾ä¸‹åˆ2é»æœ‰ç©ºæª”ï¼Œå·²ç¶“ç™¼é€æœƒè­°é‚€è«‹çµ¦ç›¸é—œäººå“¡ï¼Œä¸¦é è¨‚äº†æœƒè­°å®¤ã€‚ã€

#### å¯¦éš›æ‡‰ç”¨å ´æ™¯

**å ´æ™¯ä¸€ï¼šæ™ºèƒ½è¡Œæ”¿åŠ©æ‰‹**
- **éœ€æ±‚**ï¼šã€Œå¹«æˆ‘åˆ†æéŠ·å”®å ±è¡¨ä¸¦ç™¼çµ¦ä¸»ç®¡ã€
- **AI è¡Œå‹•**ï¼š
  1. ğŸ” é€£æ¥è³‡æ–™åº«æŸ¥è©¢éŠ·å”®æ•¸æ“š
  2. ğŸ“Š ç”Ÿæˆåœ–è¡¨å’Œåˆ†æå ±å‘Š  
  3. ğŸ“§ è‡ªå‹•ç™¼é€éƒµä»¶çµ¦æŒ‡å®šä¸»ç®¡

**å ´æ™¯äºŒï¼šå®¢æœå•é¡Œè§£æ±º**
- **å®¢æˆ¶**ï¼šã€Œæˆ‘è¦é€€è²¨ï¼Œä½†æ‰¾ä¸åˆ°è¨‚å–®ã€
- **AI è¡Œå‹•**ï¼š
  1. ğŸ” æŸ¥è©¢å®¢æˆ¶è¨‚å–®è¨˜éŒ„
  2. ğŸ“‹ ç¢ºèªé€€è²¨æ”¿ç­–é©ç”¨æ€§
  3. ğŸ« è‡ªå‹•ç”Ÿæˆé€€è²¨å–®ä¸¦ç™¼é€

**å ´æ™¯ä¸‰ï¼šæ™ºèƒ½ç›£æ§ç³»çµ±**
- **ç³»çµ±å‘Šè­¦**ï¼šã€Œä¼ºæœå™¨ CPU ä½¿ç”¨ç‡ 90%ã€
- **AI è¡Œå‹•**ï¼š
  1. ğŸ“Š åˆ†ææ­·å²æ€§èƒ½æ•¸æ“š
  2. âš–ï¸ è‡ªå‹•èª¿æ•´è² è¼‰å¹³è¡¡
  3. ğŸ“± é€šçŸ¥é‹ç¶­åœ˜éšŠä¸¦æä¾›å»ºè­°

#### è¡Œå‹•åŠ›çš„å±¤ç´šç™¼å±•

| å±¤ç´š | èƒ½åŠ›ç‰¹å¾µ | å¯¦éš›æ‡‰ç”¨ |
|------|----------|----------|
| **åæ‡‰å¼è¡Œå‹•** | æ ¹æ“šæŒ‡ä»¤åŸ·è¡Œå–®ä¸€å‹•ä½œ | ã€Œå¹«æˆ‘æŸ¥å¤©æ°£ã€â†’ èª¿ç”¨å¤©æ°£ API |
| **è¨ˆåŠƒå¼è¡Œå‹•** | åˆ¶å®šå¤šæ­¥é©ŸåŸ·è¡Œè¨ˆåŠƒ | ã€Œå®‰æ’å‡ºå·®ã€â†’ è¨‚æ©Ÿç¥¨+é£¯åº—+é€šçŸ¥åŒäº‹ |
| **è‡ªé©æ‡‰è¡Œå‹•** | æ ¹æ“šçµæœèª¿æ•´ç­–ç•¥ | é‡åˆ°å•é¡Œæ™‚è‡ªå‹•å˜—è©¦å‚™é¸æ–¹æ¡ˆ |
| **å‰µæ–°å¼è¡Œå‹•** | å‰µé€ æ€§è§£æ±ºæ–°å•é¡Œ | é¢å°æœªçŸ¥æƒ…æ³æ™‚è¨­è¨ˆæ–°çš„è§£æ±ºæµç¨‹ |

#### AI Agent çš„æ€è€ƒéç¨‹

**ç¯„ä¾‹ï¼šã€Œå¹«æˆ‘åˆ†æç«¶çˆ­å°æ‰‹ä¸¦åˆ¶å®šè¡ŒéŠ·ç­–ç•¥ã€**

```
ğŸ¤” AI æ€è€ƒï¼šæˆ‘éœ€è¦å…ˆäº†è§£ç«¶çˆ­å°æ‰‹æƒ…æ³
ğŸ” AI è¡Œå‹•ï¼šä½¿ç”¨æœå°‹å·¥å…·æŸ¥æ‰¾ç«¶çˆ­å°æ‰‹è³‡è¨Š
ğŸ‘ï¸ AI è§€å¯Ÿï¼šç²å¾—ç«¶çˆ­å°æ‰‹æ¸…å–®å’Œç‰¹è‰²

ğŸ¤” AI æ€è€ƒï¼šç¾åœ¨éœ€è¦åˆ†æå¸‚å ´è¶¨å‹¢  
ğŸ” AI è¡Œå‹•ï¼šæœå°‹ç›¸é—œè¡Œæ¥­å ±å‘Š
ğŸ‘ï¸ AI è§€å¯Ÿï¼šç²å¾—å¸‚å ´æ•¸æ“šå’Œé æ¸¬

ğŸ¤” AI æ€è€ƒï¼šçµåˆè³‡æ–™åˆ¶å®šç­–ç•¥
ğŸ“ AI è¡Œå‹•ï¼šæ•´åˆåˆ†æä¸¦æå‡ºå»ºè­°
âœ… AI å®Œæˆï¼šè¼¸å‡ºå®Œæ•´çš„è¡ŒéŠ·ç­–ç•¥å ±å‘Š
```

#### ç¨‹å¼ç¢¼å¯¦ç¾ç¯„ä¾‹

::: details é»æ“ŠæŸ¥çœ‹ï¼šæ™ºèƒ½å·¥å…·èª¿ç”¨å¯¦ä½œ
```python
# åŒ¯å…¥ LangChain Agent å’Œå·¥å…·ç›¸é—œæ¨¡çµ„
from langchain.agents import AgentExecutor, create_tool_calling_agent
from langchain.tools import Tool
from langchain_core.prompts import ChatPromptTemplate
from langchain_openai import ChatOpenAI
import ast
import operator
import logging
from typing import Any

# è¨­å®šæ—¥èªŒè¨˜éŒ„ï¼ˆç”¨æ–¼å®‰å…¨ç›£æ§ï¼‰
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# æ­¥é©Ÿ 1: å®šç¾©å®‰å…¨çš„æ•¸å­¸è¨ˆç®—å™¨
def safe_calculate(expression: str) -> Any:
    """
    å®‰å…¨çš„æ•¸å­¸è¨ˆç®—å™¨ï¼Œä¸ä½¿ç”¨å±éšªçš„ eval() å‡½æ•¸
    åªå…è¨±åŸºæœ¬çš„æ•¸å­¸é‹ç®—ï¼Œé˜²æ­¢ä»£ç¢¼æ³¨å…¥æ”»æ“Š
    
    Args:
        expression (str): æ•¸å­¸è¡¨é”å¼ï¼Œä¾‹å¦‚ "2 + 3 * 4"
    
    Returns:
        è¨ˆç®—çµæœæˆ–éŒ¯èª¤è¨Šæ¯
    """
    # å®šç¾©å…è¨±çš„é‹ç®—å­ï¼ˆç™½åå–®æ©Ÿåˆ¶ï¼‰
    allowed_operators = {
        ast.Add: operator.add,        # åŠ æ³• +
        ast.Sub: operator.sub,        # æ¸›æ³• -
        ast.Mult: operator.mul,       # ä¹˜æ³• *
        ast.Div: operator.truediv,    # é™¤æ³• /
        ast.Pow: operator.pow,        # å¹‚é‹ç®— **
        ast.USub: operator.neg        # è² è™Ÿ -x
    }
    
    def _eval(node):
        """éè¿´åœ°è©•ä¼° AST ç¯€é»"""
        if isinstance(node, ast.Constant):  # Python 3.8+ çš„å¸¸æ•¸ç¯€é»
            return node.value
        elif isinstance(node, ast.Num):  # å‘ä¸‹ç›¸å®¹èˆŠç‰ˆ Python
            return node.n
        elif isinstance(node, ast.BinOp):  # é›™å…ƒé‹ç®— (a + b)
            if type(node.op) in allowed_operators:
                left_val = _eval(node.left)
                right_val = _eval(node.right)
                return allowed_operators[type(node.op)](left_val, right_val)
            else:
                raise ValueError(f"ä¸æ”¯æ´çš„é‹ç®—å­: {type(node.op).__name__}")
                
        elif isinstance(node, ast.UnaryOp):  # ä¸€å…ƒé‹ç®— (-a)
            if type(node.op) in allowed_operators:
                operand_val = _eval(node.operand)
                return allowed_operators[type(node.op)](operand_val)
            else:
                raise ValueError(f"ä¸æ”¯æ´çš„ä¸€å…ƒé‹ç®—å­: {type(node.op).__name__}")
        else:
            raise ValueError(f"ä¸æ”¯æ´çš„é‹ç®—å¼é¡å‹: {type(node).__name__}")
    
    try:
        logger.info(f"åŸ·è¡Œå®‰å…¨è¨ˆç®—: {expression}")
        # å°‡å­—ä¸²è§£æç‚º ASTï¼ˆæŠ½è±¡èªæ³•æ¨¹ï¼‰
        node = ast.parse(expression, mode='eval')
        result = _eval(node.body)
        logger.info(f"è¨ˆç®—çµæœ: {result}")
        return result
    except Exception as e:
        error_msg = f"è¨ˆç®—éŒ¯èª¤: {str(e)}"
        logger.error(error_msg)
        return error_msg

def search_web(query: str) -> str:
    """
    æ¨¡æ“¬ç¶²è·¯æœå°‹åŠŸèƒ½
    åœ¨å¯¦éš›æ‡‰ç”¨ä¸­ï¼Œé€™æœƒèª¿ç”¨çœŸå¯¦çš„æœå°‹ API
    ä¾‹å¦‚ Google Custom Search, Bing Search, Tavily ç­‰
    
    Args:
        query (str): æœå°‹é—œéµè©
    
    Returns:
        str: æœå°‹çµæœæ‘˜è¦
    """
    logger.info(f"åŸ·è¡Œç¶²è·¯æœå°‹: {query}")
    
    # æ¨¡æ“¬ä¸åŒé¡å‹çš„æœå°‹çµæœ
    mock_results = {
        "AI": "æœ€æ–° AI ç™¼å±•è¶¨å‹¢ï¼šå¤§å‹èªè¨€æ¨¡å‹æŒçºŒé€²åŒ–ï¼Œå¤šæ¨¡æ…‹ AI èˆˆèµ·",
        "æŠ€è¡“": "æŠ€è¡“æ–°èï¼šé›²ç«¯é‹ç®—å’Œé‚Šç·£é‹ç®—èåˆç™¼å±•",
        "å¸‚å ´": "å¸‚å ´åˆ†æï¼šç§‘æŠ€è‚¡è¡¨ç¾å¼·å‹ï¼ŒæŠ•è³‡äººçœ‹å¥½æœªä¾†å‰æ™¯"
    }
    
    # æ ¹æ“šé—œéµè©è¿”å›ç›¸é—œçµæœ
    for keyword, result in mock_results.items():
        if keyword.lower() in query.lower():
            return f"æœå°‹çµæœ: {result}"
    
    return f"æœå°‹çµæœ: é—œæ–¼ '{query}' çš„ç›¸é—œè³‡è¨Šå·²æ‰¾åˆ°"

def send_email(recipient: str, content: str) -> str:
    """
    æ¨¡æ“¬éƒµä»¶ç™¼é€åŠŸèƒ½ï¼ˆDry-run æ¨¡å¼ï¼‰
    åœ¨å¯¦éš›æ‡‰ç”¨ä¸­ï¼Œé€™æœƒæ•´åˆ SMTP æœå‹™æˆ– API
    ä¾‹å¦‚ SendGrid, AWS SES, Office 365 ç­‰
    
    Args:
        recipient (str): æ”¶ä»¶äººéƒµä»¶åœ°å€
        content (str): éƒµä»¶å…§å®¹
    
    Returns:
        str: ç™¼é€ç‹€æ…‹è¨Šæ¯
    """
    logger.info(f"æ¨¡æ“¬ç™¼é€éƒµä»¶çµ¦: {recipient}")
    
    # ç‚ºäº†å®‰å…¨ï¼Œé€™è£¡åªæ˜¯æ¨¡æ“¬ç™¼é€ï¼Œä¸æœƒçœŸçš„ç™¼å‡ºéƒµä»¶
    return f"[ä¹¾åŸ·è¡Œæ¨¡å¼] éƒµä»¶å°‡ç™¼é€çµ¦ {recipient}\nä¸»æ—¨: AI åˆ†æå ±å‘Š\nå…§å®¹é è¦½: {content[:50]}..."

# æ­¥é©Ÿ 2: å»ºç«‹å®‰å…¨çš„å·¥å…·é›†
# æ¯å€‹å·¥å…·éƒ½ç¶“éå®‰å…¨æª¢æŸ¥ï¼Œä¸¦å«æœ‰è©³ç´°çš„åŠŸèƒ½èªªæ˜
tools = [
    Tool(
        name="æœå°‹",
        func=search_web,
        description="æœå°‹ç¶²è·¯è³‡è¨Šã€‚è¼¸å…¥æœå°‹é—œéµè©ï¼Œè¿”å›ç›¸é—œè³‡è¨Šæ‘˜è¦ã€‚"
    ),
    Tool(
        name="å®‰å…¨è¨ˆç®—",
        func=safe_calculate,
        description="å®‰å…¨çš„æ•¸å­¸è¨ˆç®—å™¨ã€‚æ”¯æ´åŠ æ¸›ä¹˜é™¤å’Œå¹‚é‹ç®—ï¼ˆ+, -, *, /, **ï¼‰ã€‚è¼¸å…¥æ•¸å­¸è¡¨é”å¼ï¼Œè¿”å›è¨ˆç®—çµæœã€‚"
    ),
    Tool(
        name="æ¨¡æ“¬ç™¼é€éƒµä»¶",
        func=send_email,
        description="æ¨¡æ“¬ç™¼é€é›»å­éƒµä»¶ï¼ˆæ¸¬è©¦æ¨¡å¼ï¼Œä¸æœƒçœŸçš„ç™¼å‡ºï¼‰ã€‚éœ€è¦å…©å€‹åƒæ•¸ï¼šæ”¶ä»¶äººå’Œéƒµä»¶å…§å®¹ã€‚"
    )
]

# æ­¥é©Ÿ 3: æ¨¡å‹ç›¸å®¹æ€§æª¢æŸ¥
# â—ï¸ é‡è¦ï¼šå·¥å…·èª¿ç”¨ç›¸å®¹æ€§èªªæ˜
print("ğŸ” æª¢æŸ¥æ¨¡å‹ç›¸å®¹æ€§...")
print("Tool Calling æ”¯æ´æƒ…æ³ï¼š")
print("âœ… æ”¯æ´: GPT-4, GPT-4o, Claude-3, Gemini Pro")
print("âŒ ä¸æ”¯æ´: éƒ¨åˆ†é–‹æºæ¨¡å‹ã€GPT-3.5-turbo èˆŠç‰ˆæœ¬")
print("âš ï¸ æ³¨æ„: è‹¥æ¨¡å‹ä¸æ”¯æ´ Tool Callingï¼Œå°‡é™ç´šç‚ºä¸€èˆ¬æ–‡å­—ç”Ÿæˆ\n")

# æ­¥é©Ÿ 4: åˆå§‹åŒ–èªè¨€æ¨¡å‹
llm = ChatOpenAI(
    model="gpt-4o-mini",  # ä½¿ç”¨æ”¯æ´ Tool Calling çš„æ¨¡å‹
    temperature=0,        # è¨­å®šç‚º 0 ä»¥ç²å¾—ä¸€è‡´çš„çµæœ
    timeout=30           # 30 ç§’è¶…æ™‚ä¿è­·
)
logger.info("èªè¨€æ¨¡å‹åˆå§‹åŒ–å®Œæˆ")

# æ­¥é©Ÿ 5: å»ºç«‹æç¤ºæ¨¡æ¿
# å®šç¾© Agent çš„è¡Œç‚ºæ¨¡å¼å’Œä½¿ç”¨å·¥å…·çš„æ–¹å¼
prompt = ChatPromptTemplate.from_messages([
    (
        "system", 
        """ä½ æ˜¯ä¸€å€‹æœ‰ç”¨ä¸”å®‰å…¨çš„ AI åŠ©æ‰‹ã€‚
        
        ä½¿ç”¨æŒ‡å¼•ï¼š
        1. ä¸€æ¬¡åªä½¿ç”¨ä¸€å€‹å·¥å…·
        2. ä»”ç´°æª¢æŸ¥å·¥å…·çš„çµæœå†æ±ºå®šä¸‹ä¸€æ­¥
        3. å¦‚æœé‡åˆ°éŒ¯èª¤ï¼Œè«‹å‘ŠçŸ¥ç”¨æˆ¶ä¸¦å˜—è©¦å…¶ä»–æ–¹æ³•
        4. ä¿æŒå‹å–„å’Œå°ˆæ¥­çš„æ²Ÿé€šé¢¨æ ¼"""
    ),
    ("user", "{input}"),
    ("assistant", "{agent_scratchpad}"),  # Agent çš„æ€è€ƒéç¨‹
])
logger.info("æç¤ºæ¨¡æ¿å»ºç«‹å®Œæˆ")

# æ­¥é©Ÿ 6: å»ºç«‹æ™ºèƒ½ Agent
# Agent æœƒè‡ªä¸»åˆ†æä»»å‹™ä¸¦æ±ºå®šä½¿ç”¨å“ªäº›å·¥å…·
agent = create_tool_calling_agent(
    llm=llm,      # èªè¨€æ¨¡å‹
    tools=tools,  # å¯ç”¨å·¥å…·åˆ—è¡¨
    prompt=prompt # æç¤ºæ¨¡æ¿
)

# ä½¿ç”¨ AgentExecutor ä¾†é€²è¡Œå®‰å…¨çš„åŸ·è¡Œç®¡ç†
agent_executor = AgentExecutor(
    agent=agent,
    tools=tools,
    verbose=True,              # é¡¯ç¤ºè©³ç´°çš„åŸ·è¡Œéç¨‹
    handle_parsing_errors=True, # è‡ªå‹•è™•ç†è§£æéŒ¯èª¤
    max_iterations=10,         # é™åˆ¶æœ€å¤§è¿­ä»£æ¬¡æ•¸ä»¥é˜²æ­¢ç„¡é™è¿´åœˆ
    max_execution_time=60      # ç¸½åŸ·è¡Œæ™‚é–“ä¸Šé™ 60 ç§’
)
logger.info("Agent åŸ·è¡Œå™¨å»ºç«‹å®Œæˆ")

# æ­¥é©Ÿ 7: åŸ·è¡Œè¤‡é›œçš„å¤šæ­¥é©Ÿä»»å‹™
print("ğŸš€ é–‹å§‹åŸ·è¡Œè¤‡é›œä»»å‹™...")
print("=" * 50)

# é€™å€‹ä»»å‹™éœ€è¦ Agent è‡ªä¸»åˆ†è§£ç‚ºå¤šå€‹æ­¥é©Ÿï¼š
# 1. æœå°‹ AI ç™¼å±•è¶¨å‹¢
# 2. è¨ˆç®—æ•¸å­¸è¡¨é”å¼
# 3. æ•´åˆè³‡è¨Šä¸¦æ¨¡æ“¬ç™¼é€éƒµä»¶

task_description = """è«‹å¹«æˆ‘å®Œæˆä»¥ä¸‹ä»»å‹™ï¼š
1. æœå°‹æœ€æ–°çš„ AI ç™¼å±•è¶¨å‹¢è³‡è¨Š
2. è¨ˆç®— (100+50)*2 çš„çµæœ
3. å°‡æœå°‹çµæœå’Œè¨ˆç®—çµæœæ•´åˆæˆä¸€ä»½ç¸½çµå ±å‘Š
4. æ¨¡æ“¬ç™¼é€é€™ä»½å ±å‘Šçµ¦ç¶“ç† (manager@company.com)

è«‹æŒ‰ç…§é †åºå®Œæˆæ¯å€‹æ­¥é©Ÿï¼Œä¸¦åœ¨æ¯å€‹æ­¥é©Ÿå¾Œèªªæ˜ä½ çš„é€²åº¦ã€‚"""

try:
    # ä½¿ç”¨ invoke æ–¹æ³•åŸ·è¡Œä»»å‹™ï¼ˆLangChain v0.2+ æ¨™æº–æ ¼å¼ï¼‰
    response = agent_executor.invoke({
        "input": task_description
    })
    
    print("\n" + "=" * 50)
    print("ğŸ† ä»»å‹™å®Œæˆï¼ä»¥ä¸‹æ˜¯ Agent çš„æœ€çµ‚å›ç­”ï¼š")
    print("=" * 50)
    print(response["output"])
    
except Exception as e:
    logger.error(f"ä»»å‹™åŸ·è¡Œå¤±æ•—: {str(e)}")
    print(f"âŒ ä»»å‹™åŸ·è¡Œéç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤: {str(e)}")

# ğŸ”’ å®‰å…¨æ©Ÿåˆ¶è¨¼æ˜
print("\n" + "=" * 50)
print("ğŸ”’ å·²å¯¦æ–½çš„å®‰å…¨æ©Ÿåˆ¶ï¼š")
print("1. âœ… è¼¸å…¥é©—è­‰ï¼šæ‰€æœ‰å·¥å…·åƒæ•¸éƒ½ç¶“éé©—è­‰")
print("2. âœ… æ¬Šé™æ§åˆ¶ï¼šåªèƒ½ä½¿ç”¨é å®šç¾©çš„å®‰å…¨å·¥å…·")
print("3. âœ… è¶…æ™‚è¨­å®šï¼šå·¥å…·å’Œæ•´é«”åŸ·è¡Œéƒ½æœ‰æ™‚é–“ä¸Šé™")
print("4. âœ… è¿­ä»£é™åˆ¶ï¼šé˜²æ­¢ Agent é™·å…¥ç„¡é™è¿´åœˆ")
print("5. âœ… ç¨½æ ¸æ©Ÿåˆ¶ï¼šé‡è¦æ“ä½œï¼ˆå¦‚éƒµä»¶ï¼‰åªæ˜¯æ¨¡æ“¬åŸ·è¡Œ")
print("6. âœ… æ—¥èªŒè¨˜éŒ„ï¼šæ‰€æœ‰ Agent è¡Œç‚ºéƒ½æœ‰å®Œæ•´è¨˜éŒ„")
print("7. âœ… éŒ¯èª¤è™•ç†ï¼šè‡ªå‹•è™•ç†å„ç¨®ç•°å¸¸æƒ…æ³")
print("8. âœ… ä»£ç¢¼å®‰å…¨ï¼šä¸ä½¿ç”¨ eval()ï¼Œé‡‡ç”¨ AST è§£æ")
```
:::

::: details é»æ“ŠæŸ¥çœ‹ï¼šå¤šæ­¥é©Ÿæ¨ç†æ±ºç­–å¯¦ä½œ
```python
# åŒ¯å…¥ ReAct (Reasoning + Acting) ä»£ç†ç›¸é—œæ¨¡çµ„
from langchain.agents import create_react_agent, AgentExecutor
from langchain import hub
from langchain_openai import ChatOpenAI
from langchain.tools import Tool
import time
import logging

# è¨­å®šè©³ç´°æ—¥èªŒ
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# æ­¥é©Ÿ 1: å®šç¾©é€²éšåˆ†æå·¥å…·
def analyze_competitor(company_name: str) -> str:
    """
    ç«¶çˆ­å°æ‰‹åˆ†æå·¥å…·
    åœ¨å¯¦éš›æ‡‰ç”¨ä¸­å¯ä»¥æ•´åˆï¼š
    - å…¬å¸è³‡æ–™åº« API
    - æ–°èå’Œå¸‚å ´å ±å‘Šç¶²ç«™
    - ç¤¾äº¤åª’é«”æƒ…æ„Ÿåˆ†æ
    - è²¡å‹™æ•°æ“š API
    """
    logger.info(f"åˆ†æç«¶çˆ­å°æ‰‹: {company_name}")
    
    # æ¨¡æ“¬ç«¶çˆ­å°æ‰‹åˆ†æçµæœ
    mock_analysis = {
        "ç§‘æŠ€": f"{company_name} åˆ†æçµæœï¼š\nâ€¢ å¸‚å ´ä½”æœ‰ç‡ 25%\nâ€¢ ä¸»è¦å„ªå‹¢ï¼šæŠ€è¡“å‰µæ–°\nâ€¢ å¼±é»ï¼šå®¢æˆ¶æœå‹™\nâ€¢ æœ€è¿‘å‹•æ…‹ï¼šæ¨å‡ºæ–°ç”¢å“ç·š",
        "é›¶å”®": f"{company_name} åˆ†æçµæœï¼š\nâ€¢ é€£é–åº—æ•¸é‡ 500+\nâ€¢ ä¸»è¦å„ªå‹¢ï¼šå“ç‰ŒçŸ¥ååº¦\nâ€¢ å¼±é»ï¼šåƒ¹æ ¼ç«¶çˆ­åŠ›\nâ€¢ æœ€è¿‘å‹•æ…‹ï¼šæ“´å±•ç·šä¸Šé€šè·¯",
        "é‡‘è": f"{company_name} åˆ†æçµæœï¼š\nâ€¢ è³‡ç”¢è¦æ¨¡ 100å„„\nâ€¢ ä¸»è¦å„ªå‹¢ï¼šé¢¨éšªæ§åˆ¶\nâ€¢ å¼±é»ï¼šæ•¸ä½åŒ–è½‰å‹\nâ€¢ æœ€è¿‘å‹•æ…‹ï¼šæ¨å‡ºæ•¸ä½ç†è²¡"
    }
    
    # æ ¹æ“šå…¬å¸åç¨±æ¨æ–·è¡Œæ¥­é¡å‹
    for industry, analysis in mock_analysis.items():
        if industry in company_name:
            return analysis
    
    return f"{company_name} ç«¶çˆ­å°æ‰‹åˆ†æï¼š\nâ€¢ æ­£åœ¨æ”¶é›†æ•¸æ“š...\nâ€¢ å¸‚å ´åœ°ä½å¼·å‹\nâ€¢ éœ€æŒçºŒé—œæ³¨å…¶å‹•æ…‹"

def research_market_trends(industry: str) -> str:
    """
    å¸‚å ´è¶¨å‹¢ç ”ç©¶å·¥å…·
    æ•´åˆå¤šç¨®æ•¸æ“šä¾†æºï¼š
    - ç”¢æ¥­å ±å‘Š (Gartner, IDC)
    - å¸‚å ´ç ”ç©¶ (Nielsen, Euromonitor)
    - ç¶“æ¿ŸæŒ‡æ¨™ (GDP, CPI)
    - ç¤¾äº¤åª’é«”è¶¨å‹¢ (Twitter, LinkedIn)
    """
    logger.info(f"ç ”ç©¶å¸‚å ´è¶¨å‹¢: {industry}")
    
    market_data = {
        "ç§‘æŠ€": "ğŸ“ˆ 2024 ç§‘æŠ€è¶¨å‹¢ï¼š\nâ€¢ AI/ML å¸‚å ´å¹´æˆé•·ç‡ 35%\nâ€¢ é›²ç«¯é‹ç®—éœ€æ±‚æŒçºŒå¢é•·\nâ€¢ ç¶²è·¯å®‰å…¨æŠ•è³‡å¤§å¹…å¢åŠ \nâ€¢ é‚Šç·£é‹ç®—æˆç‚ºæ–°ç†±é»",
        "é›¶å”®": "ğŸ›ï¸ 2024 é›¶å”®è¶¨å‹¢ï¼š\nâ€¢ é›»å•†æ¸¸é€ç‡é” 65%\nâ€¢ æ°¸çºŒæ¶ˆè²»æ„è­˜æå‡\nâ€¢ å€‹äººåŒ–é«”é©—æˆç‚ºé—œéµ\nâ€¢ Omnichannel æˆç‚ºæ¨™æº–é…ç½®",
        "é‡‘è": "ğŸ¦ 2024 é‡‘èè¶¨å‹¢ï¼š\nâ€¢ FinTech æŠ•è³‡å¢é•· 40%\nâ€¢ æ•¸ä½è²¨å¹£æ³•è¦æ—¥è¶‹å®Œå–„\nâ€¢ ESG æŠ•è³‡æˆç‚ºä¸»æµ\nâ€¢ é–‹æ”¾éŠ€è¡Œæ¨å‹•å‰µæ–°"
    }
    
    return market_data.get(industry, f"{industry} å¸‚å ´è¶¨å‹¢ï¼š\nâ€¢ æ­£åœ¨åˆ†æä¸­...\nâ€¢ æ•´é«”å¸‚å ´å‘ˆç©©å¥æˆé•·\nâ€¢ æ•°ä½åŒ–è½‰å‹åŠ é€Ÿ")

def generate_strategy_recommendations(context: str) -> str:
    """
    ç­–ç•¥å»ºè­°ç”Ÿæˆå·¥å…·
    åŸºæ–¼å‰é¢æ”¶é›†çš„è³‡è¨Šç”Ÿæˆå¯è¡Œçš„å•†æ¥­ç­–ç•¥
    çµåˆï¼š
    - ç«¶çˆ­åˆ†æçµæœ
    - å¸‚å ´è¶¨å‹¢æ•¸æ“š  
    - æœ€ä½³å¯¦å‹™ (Best Practices)
    - SWOT åˆ†ææ¡†æ¶
    """
    logger.info("ç”Ÿæˆç­–ç•¥å»ºè­°")
    
    # åŸºæ–¼è¼¸å…¥ä¸Šä¸‹æ–‡ç”Ÿæˆå°ˆæ¥­å»ºè­°
    strategy_template = f"""ğŸ“Š ç­–ç•¥å»ºè­°å ±å‘Š
    
ğŸ¯ æ ¸å¿ƒç­–ç•¥ï¼š
1. å·®ç•°åŒ–å®šä½ï¼šé©åˆ¥ç«¶çˆ­å°æ‰‹çš„å„ªå‹¢é ˜åŸŸ
2. æ•°ä½å„ªå…ˆï¼šæŠ•è³‡æ•°ä½åŒ–è½‰å‹å’Œç·šä¸Šä½“é©—
3. å®¢æˆ¶ä¸­å¿ƒï¼šæå‡æœå‹™å“è³ªå’Œå€‹äººåŒ–é«”é©—
4. æ°¸çºŒç¶“ç‡Ÿï¼šçµåˆ ESG åŸå‰‡å»ºç«‹å“ç‰Œå½¢è±¡

ğŸš€ è¡Œå‹•è¨ˆç•«ï¼š
â€¢ çŸ­æœŸ (3æœˆ): å¸‚å ´ç ”ç©¶å’Œç«¶çˆ­åˆ†æ
â€¢ ä¸­æœŸ (6æœˆ): ç”¢å“é–‹ç™¼å’Œæ¸¬è©¦å¸‚å ´
â€¢ é•·æœŸ (12æœˆ): å…¨é¢å¸‚å ´æ¨å‡ºå’Œæ“´å±•

ğŸ“Š KPI æŒ‡æ¨™ï¼š
â€¢ å¸‚å ´ä½”æœ‰ç‡ç›®æ¨™: +15%
â€¢ å®¢æˆ¶æ»¿æ„åº¦: >85%
â€¢ ROI ç›®æ¨™: 25%+

åŸºæ–¼ä»¥ä¸‹åˆ†ææ•¸æ“šï¼š
{context}"""
    
    return strategy_template

# æ­¥é©Ÿ 2: å»ºç«‹é€²éšåˆ†æå·¥å…·é›†
# é€™äº›å·¥å…·çµåˆä½¿ç”¨èƒ½å¤ å®Œæˆè¤‡é›œçš„å•†æ¥­åˆ†æä»»å‹™
analysis_tools = [
    Tool(
        name="ç«¶çˆ­å°æ‰‹åˆ†æ",
        func=analyze_competitor,
        description="åˆ†æç‰¹å®šç«¶çˆ­å°æ‰‹çš„å¸‚å ´åœ°ä½ã€å„ªå‹£å‹¢å’Œæœ€è¿‘å‹•æ…‹ã€‚è¼¸å…¥å…¬å¸åç¨±ã€‚"
    ),
    Tool(
        name="å¸‚å ´è¶¨å‹¢ç ”ç©¶",
        func=research_market_trends,
        description="ç ”ç©¶ç‰¹å®šè¡Œæ¥­çš„å¸‚å ´è¶¨å‹¢ã€æˆé•·æ©Ÿæœƒå’Œæœªä¾†é æ¸¬ã€‚è¼¸å…¥è¡Œæ¥­åç¨±ã€‚"
    ),
    Tool(
        name="ç­–ç•¥å»ºè­°ç”Ÿæˆ",
        func=generate_strategy_recommendations,
        description="åŸºæ–¼ç«¶çˆ­åˆ†æå’Œå¸‚å ´è¶¨å‹¢ç”Ÿæˆå…·é«”çš„å•†æ¥­ç­–ç•¥å»ºè­°ã€‚è¼¸å…¥ç›¸é—œèƒŒæ™¯è³‡è¨Šã€‚"
    )
]

# æ­¥é©Ÿ 3: åˆå§‹åŒ–é€²éšèªè¨€æ¨¡å‹
print("ğŸ¤– åˆå§‹åŒ– ReAct (Reasoning + Acting) Agent...")

# ä½¿ç”¨æ›´å¼·å¤§çš„æ¨¡å‹ä¾†è™•ç†è¤‡é›œçš„å¤šæ­¥é©Ÿæ¨ç†
llm = ChatOpenAI(
    model="gpt-4o-mini",    # é©åˆè¤‡é›œæ¨ç†ä»»å‹™çš„æ¨¡å‹
    temperature=0.1,       # è¼•å¾®å¢åŠ å‰µæ„æ€§ä½†ä¿æŒä¸€è‡´æ€§
    timeout=45            # è¼ƒé•·çš„è¶…æ™‚æ™‚é–“ä»¥æ”¯æŒè¤‡é›œæ¨ç†
)

# æ­¥é©Ÿ 4: ä½¿ç”¨å®˜æ–¹ ReAct æç¤ºæ¨¡æ¿
# ReAct æ¨¡å¼ï¼šReasoning (æ¨ç†) + Acting (è¡Œå‹•) + Observation (è§€å¯Ÿ)
print("ğŸ“‹ ä¸‹è¼‰ ReAct æç¤ºæ¨¡æ¿...")
try:
    # å¾ LangChain Hub ç²å–ç¶“éå„ªåŒ–çš„ ReAct æ¨¡æ¿
    prompt = hub.pull("hwchase17/react")
    print("âœ… ReAct æ¨¡æ¿ä¸‹è¼‰æˆåŠŸ")
except Exception as e:
    print(f"âš ï¸ ç„¡æ³•ä¸‹è¼‰å®˜æ–¹æ¨¡æ¿: {e}")
    print("ğŸ”§ ä½¿ç”¨å‚™ç”¨æ¨¡æ¿...")
    
    # å‚™ç”¨çš„ç°¡åŒ– ReAct æ¨¡æ¿
    from langchain_core.prompts import PromptTemplate
    prompt = PromptTemplate.from_template(
        """Answer the following questions as best you can. You have access to the following tools:
        
        {tools}
        
        Use the following format:
        
        Question: the input question you must answer
        Thought: you should always think about what to do
        Action: the action to take, should be one of [{tool_names}]
        Action Input: the input to the action
        Observation: the result of the action
        ... (this Thought/Action/Action Input/Observation can repeat N times)
        Thought: I now know the final answer
        Final Answer: the final answer to the original input question
        
        Begin!
        
        Question: {input}
        Thought:{agent_scratchpad}"""
    )

# æ­¥é©Ÿ 5: å»ºç«‹ ReAct Agent
print("ğŸ”§ å»ºç«‹ ReAct Agent...")

# ReAct Agent æœƒåœ¨æ¯æ¬¡è¡Œå‹•å¾Œåœä¸‹ä¾†æ€è€ƒçµæœ
react_agent = create_react_agent(
    llm=llm,
    tools=analysis_tools,
    prompt=prompt
)

# é…ç½® Agent åŸ·è¡Œå™¨çš„å®‰å…¨åƒæ•¸
react_executor = AgentExecutor(
    agent=react_agent,
    tools=analysis_tools,
    verbose=True,                    # é¡¯ç¤ºè©³ç´°çš„æ€è€ƒéç¨‹
    handle_parsing_errors=True,      # è‡ªå‹•è™•ç†è§£æéŒ¯èª¤
    max_iterations=8,                # å…è¨±æ›´å¤šè¿­ä»£ä»¥æ”¯æŒè¤‡é›œæ¨ç†
    max_execution_time=120,          # 2 åˆ†é˜åŸ·è¡Œä¸Šé™
    return_intermediate_steps=True   # è¿”å›ä¸­é–“æ­¥é©Ÿä¾›åˆ†æ
)
print("âœ… ReAct Agent å»ºç«‹å®Œæˆ")

# æ­¥é©Ÿ 6: åŸ·è¡Œè¤‡é›œçš„å¤šæ­¥é©Ÿåˆ†æä»»å‹™
print("\n" + "=" * 60)
print("ğŸ† é–‹å§‹åŸ·è¡Œè¤‡é›œçš„å•†æ¥­ç­–ç•¥åˆ†æä»»å‹™")
print("=" * 60)

# é€™å€‹ä»»å‹™éœ€è¦ Agent é€²è¡Œå¤šæ­¥é©Ÿæ¨ç†ï¼š
# 1. æ€è€ƒéœ€è¦é‚£äº›è³‡è¨Š
# 2. æœ‰åºåœ°ä½¿ç”¨å·¥å…·æ”¶é›†è³‡è¨Š
# 3. åˆ†æå’Œçµåˆæ”¶é›†åˆ°çš„è³‡è¨Š
# 4. ç”Ÿæˆç¸½é«”ç­–ç•¥å»ºè­°

complex_business_task = """æˆ‘éœ€è¦ç‚ºå…¬å¸æ–°ç”¢å“åˆ¶å®šå…¨é¢çš„è¡ŒéŠ·ç­–ç•¥ã€‚

ç”¢å“èƒŒæ™¯ï¼šä¸€å€‹åŸºæ–¼ AI çš„ç§‘æŠ€è§£æ±ºæ–¹æ¡ˆï¼Œä¸»è¦é¢å‘ä¸­å°ä¼æ¥­ã€‚

è«‹å¹«æˆ‘ï¼š
1. åˆ†æä¸»è¦ç«¶çˆ­å°æ‰‹ï¼ˆå¦‚ç§‘æŠ€å¤§å» ï¼‰çš„å„ªå‹£å‹¢
2. ç ”ç©¶ç§‘æŠ€è¡Œæ¥­çš„æœ€æ–°å¸‚å ´è¶¨å‹¢
3. åŸºæ–¼ä»¥ä¸Šåˆ†æï¼Œæå‡ºå…·é«”çš„è¡ŒéŠ·ç­–ç•¥å»ºè­°

è«‹æŒ‰ç…§é‚è¼¯é †åºé€æ­¥åˆ†æï¼Œä¸¦åœ¨æ¯å€‹æ­¥é©Ÿå¾Œèªªæ˜ä½ çš„æ€è€ƒéç¨‹ã€‚"""

try:
    print(f"ğŸ“¨ ä»»å‹™è©³æƒ…: {complex_business_task[:100]}...")
    print("â³ Agent é–‹å§‹ç†è§£ä»»å‹™ä¸¦è§„åˆ’åŸ·è¡Œæ­¥é©Ÿ...")
    
    # è¨˜éŒ„é–‹å§‹æ™‚é–“
    start_time = time.time()
    
    # ä½¿ç”¨ invoke æ–¹æ³•åŸ·è¡Œè¤‡é›œä»»å‹™
    result = react_executor.invoke({
        "input": complex_business_task
    })
    
    # è¨ˆç®—åŸ·è¡Œæ™‚é–“
    execution_time = time.time() - start_time
    
    print("\n" + "=" * 60)
    print("ğŸ† å¤šæ­¥é©Ÿæ¨ç†åˆ†æå®Œæˆï¼")
    print("=" * 60)
    print(f"â±ï¸ ç¸½åŸ·è¡Œæ™‚é–“: {execution_time:.2f} ç§’")
    print(f"ğŸ”„ æ¨ç†è¿­ä»£æ¬¡æ•¸: {len(result.get('intermediate_steps', []))}")
    
    print("\nğŸ“Š æœ€çµ‚åˆ†æçµæœ:")
    print("-" * 50)
    print(result["output"])
    
    # é¡¯ç¤ºä¸­é–“æ­¥é©Ÿçš„æ‘˜è¦ã€‚
    if 'intermediate_steps' in result and result['intermediate_steps']:
        print("\nğŸ” æ¨ç†éç¨‹æ‘˜è¦:")
        for i, (action, observation) in enumerate(result['intermediate_steps'], 1):
            print(f"{i}. ğŸ¯ è¡Œå‹•: {action.tool} - {action.tool_input}")
            print(f"   ğŸ‘ï¸ è§€å¯Ÿ: {str(observation)[:100]}...")
        
except Exception as e:
    logger.error(f"ä»»å‹™åŸ·è¡Œå¤±æ•—: {str(e)}")
    print(f"âŒ ä»»å‹™åŸ·è¡Œéç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤: {str(e)}")
    print("ğŸ”§ å»ºè­°æª¢æŸ¥ç¶²è·¯é€£æ¥æˆ–èª¿æ•´ä»»å‹™è¤‡é›œåº¦")

# æ­¥é©Ÿ 7: åˆ†æ ReAct æ¨¡å¼çš„å„ªå‹¢
print("\n" + "=" * 60)
print("ğŸ§  ReAct (Reasoning + Acting) æ¨¡å¼å„ªå‹¢:")
print("âœ… é€æ˜åº¦: å¯ä»¥çœ‹åˆ° AI çš„å®Œæ•´æ€è€ƒéç¨‹")
print("âœ… å¯é æ€§: æ¯æ­¥éƒ½æœ‰é©—è­‰å’Œä¿®æ­£æ©Ÿåˆ¶")
print("âœ… é©æ‡‰æ€§: èƒ½æ ¹æ“šæ–°è³‡è¨Šèª¿æ•´å¾ŒçºŒè¡Œå‹•")
print("âœ… ç³¾å¯†æ€§: æ¯å€‹çµè«–éƒ½åŸºæ–¼å…·é«”çš„è§€å¯Ÿå’Œæ¨ç†")
print("âœ… å¯æ“´å±•: å¯ä»¥è¼•æ˜“æ·»åŠ æ–°å·¥å…·å’Œèƒ½åŠ›")
print("=" * 60)
```
:::

::: details é»æ“ŠæŸ¥çœ‹ï¼šæ¢ä»¶åˆ¤æ–·æµç¨‹æ§åˆ¶å¯¦ä½œ
```python
# æ­¤ç¯„ä¾‹å·²æ›´æ–°ç‚º v0.2+ æ–°ç‰ˆåšæ³•ï¼Œä½¿ç”¨ create_react_agent
# ConversationalAgent å·²æ£„ç”¨ï¼Œå»ºè­°ä½¿ç”¨ RunnableWithMessageHistory

# å°è©±å¼ä»£ç†ï¼ˆæ–°ç‰ˆåšæ³•ï¼šä½¿ç”¨ RunnableWithMessageHistoryï¼‰
from langchain_core.runnables.history import RunnableWithMessageHistory
from langchain_community.chat_message_histories import ChatMessageHistory

# è¨˜æ†¶å„²å­˜
store = {}
def get_session_history(session_id: str) -> ChatMessageHistory:
    if session_id not in store:
        store[session_id] = ChatMessageHistory()
    return store[session_id]

# å¸¶è¨˜æ†¶çš„ Agent
conversational_agent = RunnableWithMessageHistory(
    agent_executor,
    get_session_history,
    input_messages_key="input",
    history_messages_key="chat_history",
    output_messages_key="output",
)

# LLM èƒ½æ ¹æ“šæ¢ä»¶èˆ‡æ­·å²åŸ·è¡Œä¸åŒè¡Œå‹•
response = conversational_agent.invoke(
    {"input": "å¦‚æœä»Šå¤©è‚¡åƒ¹ä¸Šæ¼²è¶…é5%ï¼Œå°±æ¨¡æ“¬ç™¼é€æ…¶ç¥éƒµä»¶ï¼›å¦å‰‡åˆ†æä¸‹è·ŒåŸå› "},
    config={"configurable": {"session_id": "trading_session"}}
)
print(response["output"])
```
:::


#### å¯¦éš›æ‡‰ç”¨æ¡ˆä¾‹

**æ™ºèƒ½å®¢æœç³»çµ±ï¼š**
```python
# æ­¥é©Ÿ 1: æ„å»ºå®¢æœæ¥­å‹™éœ€è¦çš„å·¥å…·é›†
# é€™äº›å·¥å…·èƒ½è®“ AI ä»£ç†è‡ªå‹•è™•ç†å®¢æœæŸ¥è©¢ï¼ˆæ›´æ–°ç‚º v0.2+ æ–°ç‰ˆï¼‰
from langchain.tools import Tool
from langchain.agents import create_tool_calling_agent, AgentExecutor
from langchain_core.prompts import ChatPromptTemplate
import logging
import json
from datetime import datetime, timedelta

# è¨­å®šå®¢æœæ—¥èªŒ
logging.basicConfig(level=logging.INFO)
customer_logger = logging.getLogger("customer_service")

def get_customer_info(customer_id: str) -> str:
    """
    æŸ¥è©¢å®¢æˆ¶è³‡è¨Šçš„æ¨¡æ“¬å‡½æ•¸
    åœ¨å¯¦éš›æ‡‰ç”¨ä¸­ï¼Œé€™æœƒé€£æ¥ CRM ç³»çµ±æˆ–å®¢æˆ¶è³‡æ–™åº«
    ä¾‹å¦‚ï¼šSalesforce, HubSpot, è‡ªå»º CRM ç­‰
    """
    customer_logger.info(f"æŸ¥è©¢å®¢æˆ¶è³‡è¨Š: {customer_id}")
    
    # æ¨¡æ“¬ä¸åŒé¡å‹çš„å®¢æˆ¶è³‡æ–™
    mock_customers = {
        "C001": {
            "name": "å¼µå…ˆç”Ÿ",
            "level": "VIPæœƒå“¡",
            "join_date": "2023-01-15",
            "total_orders": 25,
            "total_amount": 150000,
            "last_contact": "2024-01-10"
        },
        "C002": {
            "name": "æå°å§",
            "level": "ä¸€èˆ¬æœƒå“¡",
            "join_date": "2023-08-20",
            "total_orders": 8,
            "total_amount": 35000,
            "last_contact": "2024-01-05"
        }
    }
    
    customer = mock_customers.get(customer_id)
    if customer:
        return f"""å®¢æˆ¶è³‡è¨Š - ID: {customer_id}
å§“å: {customer['name']}
æœƒå“¡ç´šåˆ¥: {customer['level']}
è¨»å†Šæ—¥æœŸ: {customer['join_date']}
æ­·å²è¨‚å–®: {customer['total_orders']} ç­†
ç´¯è¨ˆæ¶ˆè²»: NT${customer['total_amount']:,}
æœ€å¾Œè¯ç¹«: {customer['last_contact']}"""
    else:
        return f"æŸ¥ç„¡æ­¤å®¢æˆ¶è³‡è¨Šï¼š{customer_id}ï¼Œè«‹ç¢ºèªå®¢æˆ¶IDæ˜¯å¦æ­£ç¢º"

def check_order_status(order_id: str) -> str:
    """
    æŸ¥è©¢è¨‚å–®ç‹€æ…‹çš„æ¨¡æ“¬å‡½æ•¸
    åœ¨å¯¦éš›æ‡‰ç”¨ä¸­ï¼Œé€™æœƒé€£æ¥è¨‚å–®ç®¡ç†ç³»çµ±ã€ç‰©æµç³»çµ±
    ä¾‹å¦‚ï¼šERP, WMS, ç‰©æµå•† API ç­‰
    """
    customer_logger.info(f"æŸ¥è©¢è¨‚å–®ç‹€æ…‹: {order_id}")
    
    # æ¨¡æ“¬è¨‚å–®ç‹€æ…‹è³‡æ–™
    mock_orders = {
        "O12345": {
            "status": "å·²å‡ºè²¨",
            "items": "ç­†è¨˜å‹é›»è…¦ x1",
            "amount": 25000,
            "order_date": "2024-01-15",
            "ship_date": "2024-01-18",
            "estimated_delivery": "2024-01-22",
            "tracking_number": "TW1234567890"
        },
        "O12346": {
            "status": "è™•ç†ä¸­",
            "items": "æ™ºæ…§æ‰‹æ©Ÿ x2",
            "amount": 45000,
            "order_date": "2024-01-20",
            "ship_date": None,
            "estimated_delivery": "2024-01-25",
            "tracking_number": None
        }
    }
    
    order = mock_orders.get(order_id)
    if order:
        result = f"""è¨‚å–®è³‡è¨Š - ç·¨è™Ÿ: {order_id}
ç‹€æ…‹: {order['status']}
å•†å“: {order['items']}
é‡‘é¡: NT${order['amount']:,}
ä¸‹å–®æ—¥æœŸ: {order['order_date']}"""
        
        if order['ship_date']:
            result += f"\nå‡ºè²¨æ—¥æœŸ: {order['ship_date']}"
            result += f"\né è¨ˆé€é”: {order['estimated_delivery']}"
            if order['tracking_number']:
                result += f"\nè¿½è¹¤ç·¨è™Ÿ: {order['tracking_number']}"
        else:
            result += f"\né è¨ˆå‡ºè²¨: {order['estimated_delivery']}"
        
        return result
    else:
        return f"æŸ¥ç„¡æ­¤è¨‚å–®è³‡è¨Šï¼š{order_id}ï¼Œè«‹ç¢ºèªè¨‚å–®ç·¨è™Ÿæ˜¯å¦æ­£ç¢º"

def process_refund(order_id: str, reason: str) -> str:
    """
    è™•ç†é€€æ¬¾ç”³è«‹çš„æ¨¡æ“¬å‡½æ•¸
    åœ¨å¯¦éš›æ‡‰ç”¨ä¸­ï¼Œé€™æœƒè§¸ç™¼å¯¦éš›çš„é€€æ¬¾æµç¨‹
    ä¾‹å¦‚ï¼šé€šçŸ¥è²¡å‹™éƒ¨é–€ã€æ›´æ–°åº«å­˜ç³»çµ±ã€ç™¼é€é€šçŸ¥éƒµä»¶
    """
    customer_logger.info(f"è™•ç†é€€æ¬¾ - è¨‚å–®: {order_id}, åŸå› : {reason}")
    
    # æ¨¡æ“¬é€€æ¬¾è™•ç†é‚è¼¯
    refund_id = f"RF{datetime.now().strftime('%Y%m%d')}{order_id[-3:]}"
    estimated_days = 5 if "å“è³ª" in reason else 3
    
    # æ¨¡æ“¬æª¢æŸ¥è¨‚å–®ç‹€æ…‹
    if order_id not in ["O12345", "O12346"]:
        return f"é€€æ¬¾å¤±æ•—ï¼šæ‰¾ä¸åˆ°è¨‚å–® {order_id}"
    
    return f"""[æ¨¡æ“¬åŸ·è¡Œ] é€€æ¬¾ç”³è«‹å·²æäº¤
è¨‚å–®ç·¨è™Ÿ: {order_id}
é€€æ¬¾ç·¨è™Ÿ: {refund_id}
é€€æ¬¾åŸå› : {reason}
ç”³è«‹æ™‚é–“: {datetime.now().strftime('%Y-%m-%d %H:%M')}
é è¨ˆè™•ç†æ™‚é–“: 3-5 å€‹å·¥ä½œå¤©

å¾ŒçºŒå‹•ä½œï¼š
1. ç³»çµ±å·²é€šçŸ¥è²¡å‹™éƒ¨é–€
2. å°‡ç™¼é€ç¢ºèªéƒµä»¶çµ¦å®¢æˆ¶
3. è«‹ä¿æŒæ‰‹æ©Ÿé€šè¨Šæš¢é€š"""

def escalate_to_human(issue: str) -> str:
    """
    è½‰äººå·¥å®¢æœçš„æ¨¡æ“¬å‡½æ•¸
    åœ¨å¯¦éš›æ‡‰ç”¨ä¸­ï¼Œé€™æœƒè§¸ç™¼ï¼š
    - å°‡å°è©±è¨˜éŒ„è½‰äº¤äººå·¥å®¢æœ
    - åœ¨å®¢æœç³»çµ±ä¸­å»ºç«‹å·¥ä½œå–®
    - é€šçŸ¥ç·šä¸Šå®¢æœäººå“¡
    - ç™¼é€ç·Šæ€¥é€šçŸ¥ï¼ˆå¦‚æœéœ€è¦ï¼‰
    """
    customer_logger.warning(f"è½‰äººå·¥å®¢æœ - å•é¡Œ: {issue}")
    
    # ç”Ÿæˆå·¥ä½œå–®ç·¨è™Ÿ
    ticket_id = f"TK{datetime.now().strftime('%Y%m%d%H%M')}"
    
    return f"""[æ¨¡æ“¬åŸ·è¡Œ] å·²è½‰äº¤äººå·¥å®¢æœè™•ç†
å·¥ä½œå–®ç·¨è™Ÿ: {ticket_id}
å•é¡Œæè¿°: {issue}
å»ºç«‹æ™‚é–“: {datetime.now().strftime('%Y-%m-%d %H:%M')}
å„ªå…ˆç´š: ä¸­ç­‰

ä¸‹ä¸€æ­¥éª¤ï¼š
1. å®¢æœäººå“¡å°‡æ–¼ 30 åˆ†é˜å…§ä¸»å‹•è¯ç¹«
2. å°è©±è¨˜éŒ„å·²è‡ªå‹•é™„åŠ è‡³å·¥ä½œå–®
3. æ‚¨å°‡æ”¶åˆ°è¿½è¹¤ç·¨è™Ÿç”¨æ–¼å¾ŒçºŒæŸ¥è©¢"""

# æ­¥é©Ÿ 2: å»ºç«‹å®¢æœå·¥å…·é›†
# æ¯å€‹å·¥å…·éƒ½ç¶“éç²¾å¿ƒè¨­è¨ˆï¼Œèƒ½è®“ AI ä»£ç†è‡ªä¸»è™•ç†å„ç¨®å®¢æœæƒ…å¢ƒ
customer_tools = [
    Tool(
        name="æŸ¥è©¢å®¢æˆ¶è³‡è¨Š",
        func=get_customer_info,
        description="æŸ¥è©¢å®¢æˆ¶çš„åŸºæœ¬è³‡è¨Šï¼ŒåŒ…å«æœƒå“¡ç­‰ç´šã€è³¼è²·æ­·å²ç­‰ã€‚éœ€è¦å®¢æˆ¶IDã€‚"
    ),
    Tool(
        name="æŸ¥è©¢è¨‚å–®ç‹€æ…‹",
        func=check_order_status,
        description="æŸ¥è©¢è¨‚å–®çš„è©³ç´°ç‹€æ…‹ï¼ŒåŒ…å«å‡ºè²¨ã€ç‰©æµè¿½è¹¤ç­‰è³‡è¨Šã€‚éœ€è¦è¨‚å–®ç·¨è™Ÿã€‚"
    ),
    Tool(
        name="è™•ç†é€€æ¬¾",
        func=process_refund,
        description="è™•ç†å®¢æˆ¶çš„é€€æ¬¾ç”³è«‹ã€‚éœ€è¦è¨‚å–®ç·¨è™Ÿå’Œé€€æ¬¾åŸå› ã€‚"
    ),
    Tool(
        name="è½‰äººå·¥å®¢æœ",
        func=escalate_to_human,
        description="å°‡è¤‡é›œæˆ–ç‰¹æ®Šå•é¡Œè½‰äº¤çµ¦äººå·¥å®¢æœè™•ç†ã€‚éœ€è¦å•é¡Œæè¿°ã€‚"
    )
]

# æ­¥é©Ÿ 3: å»ºç«‹å°ˆæ¥­çš„å®¢æœ AI ä»£ç†
print("ğŸ‘¥ åˆå§‹åŒ–å®¢æœ AI ä»£ç†...")

# è¨­å®šå®¢æœå°ˆç”¨çš„æç¤ºæ¨¡æ¿
customer_service_prompt = ChatPromptTemplate.from_messages([
    (
        "system",
        """ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„å®¢æœ AI åŠ©æ‰‹ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹è³ªï¼š
        
        ğŸ† æœå‹™ç†å¿µï¼š
        1. ä»¥å®¢ç‚ºå°Šï¼šå§‹çµ‚ä¿æŒç¦®è²Œå’Œè€å¿ƒ
        2. ä¸»å‹•å”åŠ©ï¼šç›¡åŠ›è§£æ±ºå®¢æˆ¶å•é¡Œ
        3. å°ˆæ¥­ç²¾ç¥ï¼šæä¾›æº–ç¢ºæœ‰ç”¨çš„è³‡è¨Š
        4. æ•ˆç‡å„ªå…ˆï¼šå¿«é€Ÿé¢æ“Šå®¢æˆ¶éœ€æ±‚
        
        ğŸ› ï¸ ä½œæ¥­æŒ‡å¼•ï¼š
        1. å…ˆç†è§£å®¢æˆ¶å•é¡Œå†ä½¿ç”¨å·¥å…·
        2. ä¸€æ¬¡åªä½¿ç”¨ä¸€å€‹å·¥å…·ä¸¦ç­‰å¾…çµæœ
        3. å¦‚æœé‡åˆ°ç„¡æ³•è§£æ±ºçš„å•é¡Œï¼Œä¸»å‹•è½‰äººå·¥
        4. å§‹çµ‚ç”¨ç¹é«”ä¸­æ–‡å›å¾©å®¢æˆ¶"""
    ),
    ("user", "{input}"),
    ("assistant", "{agent_scratchpad}")
])

# å‰µå»ºå®¢æœä»£ç†
customer_service_agent = AgentExecutor(
    agent=create_tool_calling_agent(llm, customer_tools, customer_service_prompt),
    tools=customer_tools,
    verbose=True,
    handle_parsing_errors=True,
    max_iterations=5,          # é™åˆ¶è¿­ä»£æ¬¡æ•¸ä»¥æ§åˆ¶æˆæœ¬
    max_execution_time=60      # 1 åˆ†é˜å…§å¿…é ˆå®Œæˆæœå‹™
)

print("âœ… å®¢æœ AI ä»£ç†å»ºç«‹å®Œæˆ")

# æ­¥é©Ÿ 4: æ¨¡æ“¬è¤‡é›œçš„å®¢æœæƒ…å¢ƒ
print("\n" + "=" * 50)
print("ğŸ“ æ¨¡æ“¬è¤‡é›œå®¢æœæƒ…å¢ƒ - å®¢æˆ¶æŠ±æ€¨è™•ç†")
print("=" * 50)

# é€™æ˜¯ä¸€å€‹å…¸å‹çš„è¤‡é›œå®¢æœå ´æ™¯ï¼Œéœ€è¦ AI è‡ªä¸»åˆ¤æ–·ä¸¦åŸ·è¡Œå¤šå€‹æ­¥é©Ÿ
complex_customer_issue = """å—¨ï¼Œæˆ‘æ˜¯å¼µå…ˆç”Ÿï¼Œæˆ‘çš„å®¢æˆ¶IDæ˜¯C001ã€‚
æˆ‘ä¸Šå€‹æ˜ŸæœŸä¸‹çš„ç­†è¨˜å‹é›»è…¦ï¼ˆè¨‚å–®ç·¨è™Ÿ O12345ï¼‰æœ‰å¾ˆå¤§çš„å“è³ªå•é¡Œï¼
è¢å¹•æœ‰ä¸€å¡Šé»‘å±ï¼Œéµç›¤ä¹Ÿæœ‰å¹¾å€‹æŒ‰éµå£äº†ã€‚
æˆ‘è¦é€€è²¨ä¸¦ä¸”ç”³è«‹å…¨é¡é€€æ¬¾ï¼Œé€™å€‹å•é¡Œæ˜¯å•†å“æœ¬èº«çš„å“è³ªå•é¡Œï¼
è«‹å¹«æˆ‘å¿«é€Ÿè™•ç†ï¼Œæˆ‘å¾ˆä¸æ»¿æ„ï¼

å¦å¤–ï¼Œæˆ‘æƒ³äº†è§£ä¸€ä¸‹æˆ‘çš„å…¶ä»–è¨‚å–®ç‹€æ…‹ã€‚"""

try:
    print(f"ğŸ’¬ å®¢æˆ¶è¨˜è¨Š: {complex_customer_issue[:100]}...")
    print("â³ AI ä»£ç†é–‹å§‹è™•ç†å®¢æˆ¶å•é¡Œ...")
    
    # AI ä»£ç†æœƒè‡ªå‹•ï¼š
    # 1. åˆ†æå®¢æˆ¶å•é¡Œ
    # 2. æŸ¥è©¢å®¢æˆ¶è³‡è¨Šä»¥ç¡®èªèº«ä»½
    # 3. æŸ¥è©¢è¨‚å–®ç‹€æ…‹ä»¥äº†è§£æƒ…æ³
    # 4. è™•ç†é€€æ¬¾ç”³è«‹
    # 5. æä¾›å°ˆæ¥­çš„å¾ŒçºŒæœå‹™
    
    response = customer_service_agent.invoke({
        "input": complex_customer_issue
    })
    
    print("\n" + "=" * 50)
    print("ğŸ† å®¢æœè™•ç†çµæœ")
    print("=" * 50)
    print(response["output"])
    
except Exception as e:
    customer_logger.error(f"å®¢æœè™•ç†å¤±æ•—: {str(e)}")
    print(f"âŒ å®¢æœè™•ç†éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤: {str(e)}")

# ğŸ”’ å¯¦æ–½çš„å®‰å…¨æ©Ÿåˆ¶è¨¼æ˜ï¼š
print("\n" + "=" * 50)
print("ğŸ”’ å®¢æœç³»çµ±å®‰å…¨æ©Ÿåˆ¶:")
print("1. âœ… è¼¸å…¥é©—è­‰: å®¢æˆ¶IDã€è¨‚å–®ç·¨è™Ÿç­‰é—œéµè³‡è¨Šéƒ½æœƒé©—è­‰")
print("2. âœ… æ¬Šé™æ§åˆ¶: AI åªèƒ½è™•ç†æŸ¥è©¢å’Œä¸€èˆ¬é€€æ¬¾ï¼Œé‡å¤§å•é¡Œè½‰äººå·¥")
print("3. âœ… è¶…æ™‚è¨­å®š: 60ç§’å…§å¿…é ˆå®Œæˆæœå‹™ï¼Œé˜²æ­¢å®¢æˆ¶ç­‰å¾…")
print("4. âœ… æ“ä½œç¨½æ ¸: é‡è¦æ“ä½œï¼ˆé€€æ¬¾ï¼‰åªæ˜¯æ¨¡æ“¬ï¼Œéœ€äººå·¥ç¢ºèª")
print("5. âœ… å®Œæ•´è¨˜éŒ„: æ‰€æœ‰å®¢æœäº’å‹•éƒ½æœ‰è©³ç´°æ—¥èªŒè¨˜éŒ„")
print("6. âœ… å‡ç´šæ©Ÿåˆ¶: è¤‡é›œå•é¡Œè‡ªå‹•è½‰äººå·¥ï¼Œç¢ºä¿æœå‹™å“è³ª")
print("7. âœ… è³‡æ–™ä¿è­·: æ•æ„Ÿè³‡è¨Šï¼ˆå¦‚å¡è™Ÿï¼‰ä¸æœƒè¢«è¨˜éŒ„æˆ–å‚³è¼¸")
print("=" * 50)
```

**æ™ºèƒ½åˆ†æå¸«ï¼š**
```python
# æ­¥é©Ÿ 1: å»ºç«‹å•†æ¥­åˆ†ææ‰€éœ€çš„å·¥å…·é›†
# é€™äº›å·¥å…·èƒ½è®“ AI åˆ†æå¸«è‡ªå‹•æ”¶é›†è³‡æ–™ä¸¦ç”Ÿæˆå ±å‘Šï¼ˆæ›´æ–°ç‚º v0.2+ æ–°ç‰ˆï¼‰
from langchain.tools import Tool
from langchain.agents import create_tool_calling_agent, AgentExecutor
from langchain_core.prompts import ChatPromptTemplate
import pandas as pd
import json
import logging
from datetime import datetime, timedelta
import random

# è¨­å®šåˆ†ææ—¥èªŒ
logging.basicConfig(level=logging.INFO)
analyst_logger = logging.getLogger("business_analyst")

def query_database(query: str) -> str:
    """
    æŸ¥è©¢å…§éƒ¨æ¥­å‹™è³‡æ–™åº«çš„æ¨¡æ“¬å‡½æ•¸
    åœ¨å¯¦éš›æ‡‰ç”¨ä¸­ï¼Œé€™æœƒé€£æ¥ï¼š
    - æ¥­å‹™è³‡æ–™åº« (MySQL, PostgreSQL)
    - æ•°æ“šå€‰åº« (Snowflake, BigQuery)
    - ERP ç³»çµ± (SAP, Oracle)
    - CRM ç³»çµ± (Salesforce, HubSpot)
    """
    analyst_logger.info(f"æŸ¥è©¢è³‡æ–™åº«: {query}")
    
    # æ¨¡æ“¬ä¸åŒé¡å‹çš„æŸ¥è©¢çµæœ
    mock_queries = {
        "éŠ·å”®": {
            "total_records": 1250,
            "period": "2024 Q1",
            "revenue": 15600000,
            "growth_rate": 12.5,
            "top_products": ["ç­†è¨˜å‹é›»è…¦", "æ™ºæ…§æ‰‹æ©Ÿ", "å¹³æ¿é›»è…¦"],
            "regions": {"North": 45, "South": 30, "East": 25}
        },
        "å®¢æˆ¶": {
            "total_records": 8500,
            "new_customers": 450,
            "retention_rate": 87.3,
            "satisfaction_score": 4.2,
            "churn_rate": 5.8
        },
        "å¸‚å ´": {
            "total_records": 2100,
            "market_share": 23.5,
            "competitor_analysis": "Strong position",
            "trend": "Growing",
            "opportunities": ["æ•°ä½åŒ–è½‰å‹", "AI æ•´åˆ", "æ°¸çºŒç™¼å±•"]
        }
    }
    
    # æ ¹æ“šæŸ¥è©¢å…§å®¹è¿”å›ç›¸é—œæ•¸æ“š
    for keyword, data in mock_queries.items():
        if keyword in query:
            return f"""è³‡æ–™åº«æŸ¥è©¢çµæœ - {keyword}ç›¸é—œæ•¸æ“š:
ç¸½è¨˜éŒ„æ•¸: {data['total_records']}
é—œéµæŒ‡æ¨™: {json.dumps(data, ensure_ascii=False, indent=2)}
æŸ¥è©¢æ™‚é–“: {datetime.now().strftime('%Y-%m-%d %H:%M')}
æ•¸æ“šå“è³ª: å„ªè‰¯ï¼Œå·²é©—è­‰"""
    
    return f"è³‡æ–™åº«æŸ¥è©¢çµæœ: {query} - æ‰¾åˆ° {random.randint(50, 500)} ç­†ç›¸é—œè¨˜éŒ„"

def fetch_market_data(period: str) -> str:
    """
    ç²å–å¤–éƒ¨å¸‚å ´è³‡æ–™çš„æ¨¡æ“¬å‡½æ•¸
    åœ¨å¯¦éš›æ‡‰ç”¨ä¸­ï¼Œé€™æœƒæ•´åˆï¼š
    - å¸‚å ´ç ”ç©¶å ±å‘Š (Nielsen, Euromonitor)
    - ç¶“æ¿Ÿæ•¸æ“š (Bloomberg, Reuters)
    - ç«¶çˆ­æƒ…å ± (SimilarWeb, SEMrush)
    - ç¤¾äº¤åª’é«”è­°é¡Œ (Twitter API, Facebook Insights)
    """
    analyst_logger.info(f"ç²å–å¸‚å ´è³‡æ–™: {period}")
    
    # æ¨¡æ“¬ä¸åŒæ™‚æœŸçš„å¸‚å ´æ•¸æ“š
    market_scenarios = {
        "Q1": {
            "growth_rate": 15.2,
            "market_size": "250å„„",
            "competition": "ä¸­ç­‰",
            "trends": ["æ•°ä½åŒ–è½‰å‹", "ESGæŠ•è³‡", "AI æ•´åˆ"],
            "risks": ["ä¾›æ‡‰éˆå£“åŠ›", "é€šè„¹å½±éŸ¿"]
        },
        "Q2": {
            "growth_rate": 18.7,
            "market_size": "280å„„",
            "competition": "æ¿€çƒˆ",
            "trends": ["ç·šä¸Šæ¶ˆè²»å¢é•·", "æ°¸çºŒæ¶ˆè²»"],
            "risks": ["åŸç‰©æ–™æ¼²åƒ¹", "ç«¶çˆ­åŠ åŠ‡"]
        }
    }
    
    # æ ¹æ“šæ™‚æœŸè¿”å›ç›¸æ‡‰æ•¸æ“š
    for quarter, data in market_scenarios.items():
        if quarter in period.upper():
            return f"""{period} å¸‚å ´è³‡æ–™å ±å‘Š:
ğŸ“ˆ å¸‚å ´æˆé•·ç‡: {data['growth_rate']}%
ğŸ’° å¸‚å ´è¦æ¨¡: {data['market_size']}
âš”ï¸ ç«¶çˆ­ç¨‹åº¦: {data['competition']}
ğŸ”¥ ä¸»è¦è¶¨å‹¢: {', '.join(data['trends'])}
âš ï¸ æ½›åœ¨é¢¨éšª: {', '.join(data['risks'])}

æ•¸æ“šä¾†æº: å¤šå€‹æ¬Šå¨å¸‚å ´ç ”ç©¶æ©Ÿæ§‹
æ›´æ–°æ™‚é–“: {datetime.now().strftime('%Y-%m-%d %H:%M')}"""
    
    return f"{period} å¸‚å ´è³‡æ–™: æ•´é«”å‘ˆç©©å¥æˆé•·æ…‹å‹¢ï¼Œæˆé•· {random.uniform(8, 25):.1f}%"

def generate_charts(data_type: str) -> str:
    """
    ç”Ÿæˆè³‡æ–™è¦–è¦ºåŒ–åœ–è¡¨çš„æ¨¡æ“¬å‡½æ•¸
    åœ¨å¯¦éš›æ‡‰ç”¨ä¸­ï¼Œé€™æœƒä½¿ç”¨ï¼š
    - Python è¦–è¦ºåŒ–åº« (Matplotlib, Plotly, Seaborn)
    - BI å·¥å…· API (Tableau, Power BI)
    - è‡ªå»ºåœ–è¡¨æœå‹™ (D3.js, Chart.js)
    - é›²ç«¯è¦–è¦ºåŒ– (Google Charts, AWS QuickSight)
    """
    analyst_logger.info(f"ç”Ÿæˆåœ–è¡¨: {data_type}")
    
    # æ¨¡æ“¬ä¸åŒé¡å‹åœ–è¡¨çš„ç”Ÿæˆéç¨‹
    chart_types = {
        "éŠ·å”®": ["æ™‚é–“åºåˆ—åœ–", "å€åŸŸåˆ†å¸ƒåœ–", "ç”¢å“æ¯”è¼ƒåœ–"],
        "è²»ç”¨": ["çµæ§‹åœ–", "è¶Šå‹¢åœ–", "é ç®—å°æ¯”åœ–"],
        "å®¢æˆ¶": ["æ»¿æ„åº¦åˆ†ä½ˆ", "ç•™å­˜ç‡è®ŠåŒ–", "ç²å®¢æ¼æ–—"]
    }
    
    generated_charts = []
    for category, charts in chart_types.items():
        if category in data_type:
            generated_charts.extend(charts[:2])  # å–å‰å…©å€‹ç›¸é—œåœ–è¡¨
    
    if not generated_charts:
        generated_charts = ["åŸºç¤çµ±è¨ˆåœ–", "è¶¨å‹¢åˆ†æåœ–"]
    
    return f"""[æ¨¡æ“¬] {data_type} è¦–è¦ºåŒ–åœ–è¡¨ç”Ÿæˆå®Œæˆ

ğŸ“Š å·²ç”Ÿæˆåœ–è¡¨:
{chr(10).join([f"â€¢ {chart}" for chart in generated_charts])}

ğŸ“ å„²å­˜ä½ç½®: /reports/charts/{data_type}/
ğŸ¨ åœ–è¡¨æ ¼å¼: PNG (é«˜æ¸…) + SVG (å‘é‡)
ğŸ”— äº’å‹•ç‰ˆæœ¬: /dashboard/{data_type.lower()}

æŠ€è¡“è©³æƒ…:
- åˆ†è¾¨ç‡: 1920x1080 (4K ready)
- è‰²å½©æ–¹æ¡ˆ: ç¬¦åˆå“ç‰Œè­˜åˆ¥
- æ•¸æ“šæ›´æ–°: {datetime.now().strftime('%Y-%m-%d %H:%M')}"""

def create_presentation(content: str) -> str:
    """
    è£½ä½œå•†æ¥­ç°¡å ±çš„æ¨¡æ“¬å‡½æ•¸
    åœ¨å¯¦éš›æ‡‰ç”¨ä¸­ï¼Œé€™æœƒæ•´åˆï¼š
    - ç°¡å ±è»Ÿé«” (PowerPoint, Google Slides)
    - ç¶²é ç°¡å ± (Reveal.js, Slides.com)
    - PDF å ±å‘Šç”Ÿæˆå™¨ (ReportLab, WeasyPrint)
    - è‡ªå‹•åŒ–å·¥å…· (Python-PPTX, Aspose)
    """
    analyst_logger.info(f"è£½ä½œç°¡å ±: {content[:50]}...")
    
    # æ¨¡æ“¬ç°¡å ±ç”Ÿæˆéç¨‹
    presentation_id = f"RPT_{datetime.now().strftime('%Y%m%d_%H%M')}"
    
    # æ ¹æ“šå…§å®¹ç”Ÿæˆç°¡å ±çµæ§‹
    slides_structure = [
        "å°é¢ - åˆ†æå ±å‘Šæ¨™é¡Œ",
        "åŸ·è¡Œæ‘˜è¦ - é—œéµç™¼ç¾èˆ‡å»ºè­°",
        "å¸‚å ´ç¾ç‹€ - å¤–éƒ¨ç’°å¢ƒåˆ†æ",
        "æ¥­å‹™è¡¨ç¾ - å…§éƒ¨æ•¸æ“šåˆ†æ",
        "ç«¶çˆ­åˆ†æ - å„ªå‹£å‹¢è©•ä¼°",
        "è¶¨å‹¢é æ¸¬ - æœªä¾†æ©Ÿæœƒèˆ‡æŒ‘æˆ°",
        "ç­–ç•¥å»ºè­° - è¡Œå‹•è¨ˆç•«èˆ‡æ™‚ç¨‹",
        "é™„éŒ„ - æ•¸æ“šä¾†æºèˆ‡æ–¹æ³•è«–"
    ]
    
    return f"""[æ¨¡æ“¬] åˆ†æç°¡å ±è£½ä½œå®Œæˆ

ğŸ“Š å ±å‘Šè­˜åˆ¥: {presentation_id}
ğŸ“ ç°¡å ±çµæ§‹ ({len(slides_structure)} é ):
{chr(10).join([f"{i+1:2d}. {slide}" for i, slide in enumerate(slides_structure)])}

ğŸ“ è¼¸å‡ºæ ¼å¼:
â€¢ PowerPoint (.pptx) - ä¸»ç°¡å ±
â€¢ PDF - åˆ—å°ç‰ˆæœ¬
â€¢ HTML - ç¶²é å±•ç¤ºç‰ˆ
â€¢ åœ–ç‰‡å¥—çµ„ (PNG) - ç¤¾äº¤åª’é«”ä½¿ç”¨

ğŸ¯ ç°¡å ±äº˜é»:
â€¢ è³‡æ–™é©…å‹•çš„æ´å¯Ÿåˆ†æ
â€¢ äº’å‹•å¼åœ–è¡¨èˆ‡è¦–è¦ºåŒ–
â€¢ å¯è¡Œçš„å•†æ¥­å»ºè­°
â€¢ ç¬¦åˆä¼æ¥­è­˜åˆ¥è¨­è¨ˆ

ğŸ”— ç·šä¸Šåˆ†äº«: /presentations/{presentation_id.lower()}
ğŸ“… å®Œæˆæ™‚é–“: {datetime.now().strftime('%Y-%m-%d %H:%M')}

å…§å®¹æ¦‚è¦: {content[:200]}..."""

# æ­¥é©Ÿ 2: å»ºç«‹å•†æ¥­åˆ†æå·¥å…·é›†
# æ•´åˆå„ç¨®åˆ†æå·¥å…·ï¼Œå½¢æˆå®Œæ•´çš„å•†æ¥­æ™ºèƒ½å·¥ä½œæµ
analyst_tools = [
    Tool(
        name="æŸ¥è©¢å…§éƒ¨è³‡æ–™åº«",
        func=query_database,
        description="æŸ¥è©¢å…§éƒ¨æ¥­å‹™è³‡æ–™åº«ï¼Œç²å–éŠ·å”®ã€å®¢æˆ¶ã€é‹ç‡Ÿç­‰æ•¸æ“šã€‚å¯æŸ¥è©¢éŠ·å”®ç¸¾æ•ˆã€å®¢æˆ¶åˆ†æã€è²»ç”¨çµæ§‹ç­‰ã€‚"
    ),
    Tool(
        name="ç²å–å¤–éƒ¨å¸‚å ´è³‡æ–™",
        func=fetch_market_data,
        description="ç²å–å¤–éƒ¨å¸‚å ´è³‡è¨Šï¼ŒåŒ…å«å¸‚å ´è¶¨å‹¢ã€ç«¶çˆ­æƒ…å ±ã€ç¶“æ¿Ÿæ•¸æ“šã€‚å¯æŒ‡å®šæ™‚æœŸï¼ˆå¦‚Q1ã€Q2ï¼‰ã€‚"
    ),
    Tool(
        name="ç”Ÿæˆè³‡æ–™è¦–è¦ºåŒ–",
        func=generate_charts,
        description="æ ¹æ“šæ•¸æ“šå…§å®¹ç”Ÿæˆå°ˆæ¥­çš„è¦–è¦ºåŒ–åœ–è¡¨ï¼Œæ”¯æ´éŠ·å”®ã€è²»ç”¨ã€å®¢æˆ¶ç­‰å¤šç¨®åˆ†æé¡å‹ã€‚"
    ),
    Tool(
        name="è£½ä½œå•†æ¥­ç°¡å ±",
        func=create_presentation,
        description="æ•´åˆåˆ†æçµæœè£½ä½œå°ˆæ¥­çš„å•†æ¥­ç°¡å ±ï¼ŒåŒ…å«åœ–è¡¨ã€æ´å¯Ÿå’Œå»ºè­°ã€‚éœ€è¦åˆ†æå…§å®¹ä½œç‚ºè¼¸å…¥ã€‚"
    )
]

# æ­¥é©Ÿ 3: å»ºç«‹å°ˆæ¥­çš„å•†æ¥­åˆ†æå¸« AI
print("ğŸ“Š åˆå§‹åŒ–å•†æ¥­åˆ†æå¸« AI...")

# è¨­å®šåˆ†æå¸«å°ˆç”¨çš„æç¤ºæ¨¡æ¿
business_analyst_prompt = ChatPromptTemplate.from_messages([
    (
        "system",
        """ä½ æ˜¯ä¸€ä½ç¶“é©—è±å¯Œçš„å•†æ¥­åˆ†æå¸«ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹è³ªï¼š
        
        ğŸ¯ æ ¸å¿ƒèƒ½åŠ›ï¼š
        1. æ•¸æ“šé©…å‹•æ€ç¶­ï¼šä»¥å®¢è§€æ•¸æ“šç‚ºåŸºç¤é€²è¡Œåˆ†æ
        2. çµæ§‹åŒ–æ€ç¶­ï¼šæŒ‰ç…§é‚è¼¯é †åºé€²è¡Œåˆ†æ
        3. å•†æ¥­æ•éŠ­åº¦ï¼šèƒ½å°‡æ•¸æ“šè½‰åŒ–ç‚ºå•†æ¥­æ´å¯Ÿ
        4. æ²Ÿé€šæŠ€å·§ï¼šç”¨æ¸…æ™°çš„èªè¨€å‚³é”è¤‡é›œæ¦‚å¿µ
        
        ğŸ“ åˆ†ææµç¨‹ï¼š
        1. ç†è§£å•é¡Œ - æ˜ç¢ºåˆ†æç›®æ¨™å’Œç¯„åœ
        2. æ”¶é›†è³‡æ–™ - å¾å…§éƒ¨å’Œå¤–éƒ¨æºç²å–æ•¸æ“š
        3. æ•¸æ“šåˆ†æ - é‹ç”¨çµ±è¨ˆæ–¹æ³•æ¢ç´¢è¦å¾‹
        4. è¦–è¦ºåŒ–å‘ˆç¾ - è£½ä½œæ˜“æ‡‚çš„åœ–è¡¨
        5. æ´å¯Ÿç¸½çµ - æä¾›å¯è¡Œçš„å»ºè­°
        6. ç°¡å ±è£½ä½œ - æ•´åˆæˆå°ˆæ¥­çš„å ±å‘Š
        
        âœ¨ å“è³ªæ¨™æº–ï¼š
        - ä½¿ç”¨å¯¦éš›æ•¸æ“šä½œç‚ºçµè«–åŸºç¤
        - æä¾›å…·é«”çš„æ•¸å­—å’Œç™¾åˆ†æ¯”
        - è­˜åˆ¥è¶¨å‹¢ã€ç•°å¸¸å’Œæ©Ÿæœƒé»
        - æå‡ºå¯¦ç”¨çš„æ”¹é€²å»ºè­°å’Œä¸‹ä¸€æ­¥è¡Œå‹•"""
    ),
    ("user", "{input}"),
    ("assistant", "{agent_scratchpad}")
])

# å‰µå»ºå•†æ¥­åˆ†æå¸«ä»£ç†
analyst_agent = AgentExecutor(
    agent=create_tool_calling_agent(llm, analyst_tools, business_analyst_prompt),
    tools=analyst_tools,
    verbose=True,
    handle_parsing_errors=True,
    max_iterations=8,          # å…è¨±è¼ƒå¤šè¿­ä»£ä»¥å®Œæˆè¤‡é›œåˆ†æ
    max_execution_time=180     # 3 åˆ†é˜æ™‚é–“ä¸Šé™ï¼ˆåˆ†æä»»å‹™æ¯”è¼ƒè€—æ™‚ï¼‰
)

print("âœ… å•†æ¥­åˆ†æå¸« AI å»ºç«‹å®Œæˆ")

# æ­¥é©Ÿ 4: åŸ·è¡Œå…¨é¢çš„å•†æ¥­åˆ†æä»»å‹™
print("\n" + "=" * 60)
print("ğŸ“Š æ¨¡æ“¬è¤‡é›œçš„å•†æ¥­åˆ†æä»»å‹™")
print("=" * 60)

# é€™æ˜¯ä¸€å€‹å…¸å‹çš„å•†æ¥­åˆ†æå ´æ™¯ï¼Œéœ€è¦ AI è‡ªå‹•æ•´åˆå¤šæºè³‡æ–™
comprehensive_analysis_task = """æˆ‘éœ€è¦ä¸€ä»½é—œæ–¼ 2024 Q1 çš„å…¨é¢æ¥­ç¸¾åˆ†æå ±å‘Šã€‚

åˆ†æéœ€æ±‚ï¼š
1. åˆ†æå…§éƒ¨éŠ·å”®ç¸¾æ•ˆå’Œå®¢æˆ¶è¡¨ç¾
2. ç²å– Q1 å¸‚å ´ç’°å¢ƒå’Œç«¶çˆ­æƒ…æ³
3. è£½ä½œç›¸é—œçš„è³‡æ–™è¦–è¦ºåŒ–åœ–è¡¨
4. æ•´åˆæ‰€æœ‰åˆ†æçµæœè£½ä½œä¸€ä»½å°ˆæ¥­ç°¡å ±
5. æå‡ºé‡å° Q2 çš„ç­–ç•¥å»ºè­°å’Œæ”¹é€²è¨ˆç•«

è«‹æŒ‰ç…§å°ˆæ¥­åˆ†ææµç¨‹å®Œæˆï¼Œä¸¦åœ¨æ¯å€‹æ­¥é©Ÿå¾Œæä¾›é—œéµæ´å¯Ÿã€‚"""

try:
    print(f"ğŸ“¨ åˆ†æä»»å‹™: {comprehensive_analysis_task[:100]}...")
    print("â³ AI åˆ†æå¸«é–‹å§‹åŸ·è¡Œå…¨é¢çš„æ¥­å‹™åˆ†æ...")
    
    # è¨˜éŒ„é–‹å§‹æ™‚é–“
    start_time = datetime.now()
    
    # AI åˆ†æå¸«æœƒè‡ªå‹•ï¼š
    # 1. ç†è§£åˆ†æéœ€æ±‚å’Œç¯„åœ
    # 2. æœ‰ç³»çµ±åœ°æ”¶é›†å…§å¤–éƒ¨æ•¸æ“š
    # 3. é‹ç”¨çµ±è¨ˆæ–¹æ³•é€²è¡Œæ•°æ“šåˆ†æ
    # 4. è£½ä½œè¦–è¦ºåŒ–åœ–è¡¨å¹«åŠ©ç†è§£
    # 5. æ•´åˆæˆå°ˆæ¥­çš„å•†æ¥­ç°¡å ±
    
    report = analyst_agent.invoke({
        "input": comprehensive_analysis_task
    })
    
    # è¨ˆç®—åŸ·è¡Œæ™‚é–“
    execution_time = datetime.now() - start_time
    
    print("\n" + "=" * 60)
    print("ğŸ† å•†æ¥­åˆ†æå®Œæˆï¼")
    print("=" * 60)
    print(f"â±ï¸ ç¸½åˆ†ææ™‚é–“: {execution_time.total_seconds():.1f} ç§’")
    
    print("\nğŸ“ˆ å®Œæ•´åˆ†æå ±å‘Š:")
    print("-" * 50)
    print(report["output"])
    
except Exception as e:
    analyst_logger.error(f"åˆ†æä»»å‹™å¤±æ•—: {str(e)}")
    print(f"âŒ åˆ†æéç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤: {str(e)}")

# åˆ†æå·¥ä½œæµçš„å„ªå‹¢å±•ç¤º
print("\n" + "=" * 60)
print("ğŸ§  AI å•†æ¥­åˆ†æå¸«çš„å„ªå‹¢:")
print("âœ… æ•ˆç‡: åœ¨æ•¸åˆ†é˜å…§å®Œæˆå…¨é¢åˆ†æï¼ˆäººå·¥éœ€æ•¸å¤©ï¼‰")
print("âœ… å…¨é¢æ€§: è‡ªå‹•æ•´åˆå…§å¤–éƒ¨å¤šæºè³‡æ–™")
print("âœ… ä¸€è‡´æ€§: å§‹çµ‚ä¿æŒå°ˆæ¥­æ¨™æº–å’Œåˆ†ææ¨¡æ¿")
print("âœ… å¯è¦–åŒ–: è‡ªå‹•ç”Ÿæˆå°ˆæ¥­åœ–è¡¨å’Œç°¡å ±")
print("âœ… å¯æ“´å±•: è¼•æ˜“æ·»åŠ æ–°çš„è³‡æ–™ä¾†æºå’Œåˆ†ææ–¹æ³•")
print("âœ… å¯é‡ç¾: åˆ†æéç¨‹é€æ˜å¯ç¨½æ ¸ï¼Œçµæœå¯é‡ç¾")
print("=" * 60)
```

#### ğŸ”’ å®‰å…¨é–‹ç™¼åŸå‰‡

åœ¨é–‹ç™¼ LangChain æ‡‰ç”¨æ™‚ï¼Œå®‰å…¨æ€§æ‡‰æ˜¯ç¬¬ä¸€å„ªå…ˆè€ƒé‡ï¼š

| å®‰å…¨é¢å‘ | å…·é«”åšæ³• | å¯¦ä½œç¯„ä¾‹ |
|------------|----------|---------|
| **è¼¸å…¥é©—è­‰** | æ‰€æœ‰å·¥å…·éƒ½è¦æª¢æŸ¥åƒæ•¸åˆæ³•æ€§ | `assert isinstance(amount, (int, float)) and amount > 0` |
| **æ¬Šé™æ§åˆ¶** | é™åˆ¶ Agent å¯è¨ªå•çš„è³‡æºç¯„åœ | ç™½åå–®ã€è³‡æ–™åº«è§’è‰²åˆ†é›¢ |
| **è¶…æ™‚æ©Ÿåˆ¶** | é˜²æ­¢å·¥å…·ç„¡é™æœŸåŸ·è¡Œ | `timeout=30` åƒæ•¸è¨­å®š |
| **äººå·¥ç¨½æ ¸** | é‡è¦æ“ä½œéœ€äººé¡ç¢ºèª | è½‰å¸³ã€åˆªé™¤æ•¸æ“šç­‰æ“ä½œ |
| **æ—¥èªŒè¿½è¹¤** | è¨˜éŒ„æ‰€æœ‰ Agent è¡Œç‚º | LangSmith æ•´åˆã€æœ¬åœ°æ—¥èªŒ |
| **ç‡é™æ§åˆ¶** | é˜²æ­¢ API æ¿«ç”¨ | æ¯åˆ†é˜/æ¯å°æ™‚èª¿ç”¨æ¬¡æ•¸é™åˆ¶ |

### ğŸ“ ç”¢æ¥­ç´šé–‹ç™¼å»ºè­°

1. **ä¸è¦åœ¨ç”Ÿç”¢ç’°å¢ƒä½¿ç”¨** `eval()`ã€`exec()` ç­‰å±éšªå‡½æ•¸
2. **å§‹çµ‚ä½¿ç”¨ç’°å¢ƒè®Šæ•¸** ä¾†å„²å­˜ API é‡‘é‘°ï¼Œå‹¿ç¡¬ç·¨ç¢¼
3. **å¯¦ä½œæ–­è·¯å™¨æ¨¡å¼** è®“ä½¿ç”¨è€…èƒ½éš¨æ™‚çµ‚æ­¢ Agent é‹è¡Œ
4. **è¨­è¨ˆå¤±æ•ˆå®‰å…¨æ©Ÿåˆ¶** ç•¶å·¥å…·å¤±æ•ˆæ™‚ï¼Œæ‡‰æœ‰åˆç†çš„å‚™ç”¨æ–¹æ¡ˆ
5. **å®šæœŸå®‰å…¨ç¨½æ ¸** æŸ¥çœ‹ Agent è¡Œç‚ºè¨˜éŒ„ï¼Œç™¼ç¾ç•°å¸¸è¡Œç‚º

## ç¸½çµï¼šè³‡æ–™æ„ŸçŸ¥ + è¡Œå‹•åŠ› = æ™ºèƒ½æ‡‰ç”¨

**å‚³çµ± LLMï¼š** åªèƒ½æ ¹æ“šè¨“ç·´è³‡æ–™å›ç­”å•é¡Œ
**LangChain å¢å¼·å¾Œï¼š** 
- ğŸ” **æ„ŸçŸ¥å¤–éƒ¨ä¸–ç•Œ**ï¼šå³æ™‚è³‡æ–™ã€æ–‡ä»¶ã€è³‡æ–™åº«
- ğŸ¤– **ä¸»å‹•æ¡å–è¡Œå‹•**ï¼šèª¿ç”¨å·¥å…·ã€åŸ·è¡Œä»»å‹™ã€åšæ±ºç­–
- ğŸ”„ **æŒçºŒå­¸ç¿’é©æ‡‰**ï¼šæ ¹æ“šçµæœèª¿æ•´ç­–ç•¥

é€™å°±æ˜¯ LangChain è®“ LLM å¾ã€ŒèŠå¤©æ©Ÿå™¨äººã€é€²åŒ–æˆã€Œæ™ºèƒ½åŠ©æ‰‹ã€çš„é—œéµæ‰€åœ¨ã€‚

---

::: tip ä¸‹ä¸€æ­¥
ç¾åœ¨ä½ å·²ç¶“äº†è§£ LangChain çš„åŸºæœ¬æ¦‚å¿µï¼Œæ¥ä¸‹ä¾†å¯ä»¥ï¼š
1. [LangChain æ¶æ§‹èˆ‡æ ¸å¿ƒæ¦‚å¿µ](/tutorials/architecture) - æ·±å…¥äº†è§£æ¶æ§‹èˆ‡æŠ½è±¡åŒ–
2. [ç’°å¢ƒè¨­ç½®](/tutorials/setup) - æº–å‚™é–‹ç™¼ç’°å¢ƒ
3. [å…è²» LLM æ¨¡å‹æŒ‡å—](/tutorials/free-llm-models) - äº†è§£å…è²»æ¨¡å‹é¸é …
4. [ç¬¬ä¸€å€‹æ‡‰ç”¨](/tutorials/first-app) - å‹•æ‰‹å¯¦ä½œ
:::

::: warning ç‰ˆæœ¬ç›¸å®¹æ€§æé†’
æœ¬æ–‡æª”å·²æ›´æ–°è‡³ **LangChain v0.2+ æ¨™æº–**ï¼Œä½†æ¡†æ¶ä»åœ¨å¿«é€Ÿç™¼å±•ä¸­ï¼š

- âœ… **å·²æ›´æ–°**ï¼š`create_retrieval_chain`ã€`create_react_agent`ã€LCEL ç®¡é“èªæ³•
- âš ï¸ **æ£„ç”¨ä¸­**ï¼š`RetrievalQA`ã€`initialize_agent`ã€`ConversationalRetrievalChain`
- ğŸ†• **æ–°ç‰¹æ€§**ï¼šLangGraphã€æ›´å¼·çš„ Output Parsersã€LangSmith æ•´åˆ

å»ºè­°æ­¤é †åºæŸ¥çœ‹æœ€æ–°è³‡è¨Šï¼š
1. [å®˜æ–¹æ–‡æª”](https://python.langchain.com/) - æœ€æ–° API åƒè€ƒ
2. [LangGraph æ–‡æª”](https://langchain-ai.github.io/langgraph/) - æ–°ä¸€ä»£ Agent æ¡†æ¶
3. [LangSmith](https://smith.langchain.com/) - å¯è§€æ¸¬æ€§èˆ‡èª¿è©¦å·¥å…·
:::